var a;function PersonView(){CDBStandardTableView.call(this);this.name="PersonView";this.showGroupDetailsId=this.showAllGroupDetails=null;this.mapVisible=this.showAllCommentDetails=this.showGroupDetailsWithHistory=false;this.sortVariable="name";this.showcontact="email";this.currentFurtherFilter="person";this.listViewTableHeight=646;this.currentTodoTimer=this.sortedData=null;this.gruppenteilnehmerdatum=new Date}Temp.prototype=CDBStandardTableView.prototype;PersonView.prototype=new Temp;personView=new PersonView;
a=PersonView.prototype;a.getData=function(e,c){if(e){if(c==null||c==true||this.sortedData==null)this.sortedData=this.sortVariable=="name"?churchcore_sortData(allPersons,this.sortVariable,null,null,"vorname"):churchcore_sortData(allPersons,this.sortVariable,null,null,"name");return this.sortedData}else return allPersons};
a.renderMenu=function(){var e=this;e.renderTodos();menu=new CC_Menu("Men&uuml;");if(menuDepth=="amain"){masterData.auth.write&&menu.addEntry("Neue Person anlegen","anewentry","star");masterData.auth.viewalldata&&menu.addEntry("Weitere Filter","aaddfilter","filter");menu.addEntry("Exporter","aexporter","share");menu.addEntry("E-Mailer","amailer","envelope");masterData.auth.sendsms&&menu.addEntry("SMS","asms","bullhorn");menu.addEntry("Gruppenliste","agroupview","th-list");menu.addEntry("Einstellungen",
"asettingsview","wrench");if(masterData.auth.admin||masterData.auth["export"])menu.addEntry("Administration","aadmin","cog");menu.addEntry("Hilfe","ahelp","question-sign")}else if(menuDepth=="aadmin"){menu.addEntry("Zur&uuml;ck zum Hauptmen&uuml;","amain","home");masterData.auth.admin&&menu.addEntry("Stammdatenpflege","amaintainview","cog");masterData.auth["export"]&&menu.addEntry("Gesamtexport","aallexporter","share");masterData.auth.admin&&menu.addEntry("LogViewer","alogviewer","eye-open")}if(menu.renderDiv("cdb_menu",
churchcore_handyformat())){var c=[];c.push('<div id="divnewentry" style="display:none" class="new-entry"></div>');c.push('<div id="divaddfilter"  style="display:none" class="new-entry"><div id="addfilter" style="width:100%;"><div style="height:200px"/></div></div>');$("#cdb_precontent").html(c.join(""));$("#cdb_menu a").click(function(){if($(this).attr("id")=="anewentry")e.renderAddEntry();else if($(this).attr("id")=="aexporter")e.exportData();else if($(this).attr("id")=="amailer")e.mailer();else if($(this).attr("id")==
"asms")e.smser();else if($(this).attr("id")=="aallexporter")window.open("?q=churchdb/export");else if($(this).attr("id")=="alogviewer")window.location.href="?q=churchcore/logviewer";else if($(this).attr("id")=="aaddfilter"){e.furtherFilterVisible=e.furtherFilterVisible?false:true;e.renderFurtherFilter()}else if($(this).attr("id")=="aadmin"){menuDepth=$(this).attr("id");e.renderMenu()}else if($(this).attr("id")=="agroupview"){menuDepth="amain";if(masterData.settings.churchdbInitView!="GroupView"){masterData.settings.churchdbInitView=
"GroupView";churchInterface.jsonWrite({func:"saveSetting",sub:"churchdbInitView",val:"GroupView"})}churchInterface.setCurrentView(groupView)}else if($(this).attr("id")=="amaintainview"){menuDepth="amain";churchInterface.setCurrentView(maintainView)}else if($(this).attr("id")=="asettingsview"){menuDepth="amain";churchInterface.setCurrentView(settingsView)}else if($(this).attr("id")=="ahelp")churchcore_openNewWindow("http://intern.churchtools.de/?q=help&doc=ChurchDB");else if($(this).attr("id")=="amain"){menuDepth=
"amain";e.renderMenu()}return false})}else $("#cdb_menu").hide()};
a.renderListMenu=function(){var e=this;f=$("searchEntry").val()!=null?$("searchEntry").val():this.getFilter("searchEntry");var c=new CC_Navi;c.addEntry(churchInterface.isCurrentView("PersonView"),"apersonview","Personenliste");c.addEntry(churchInterface.isCurrentView("MapView"),"aviewmap","Kartenansicht");masterData.auth.viewstats&&c.addEntry(churchInterface.isCurrentView("StatisticView"),"astatisticview","Statistik");masterData.auth.viewarchive&&c.addEntry(churchInterface.isCurrentView("ArchiveView"),
"aarchiveview","Archiv");c.addSearch(f);c.renderDiv("cdb_search",churchcore_handyformat());churchcore_handyformat()||$("#searchEntry").focus();this.implantStandardFilterCallbacks(this,"cdb_search");$.widget("custom.catcomplete",$.ui.autocomplete,{_renderMenu:function(g,h){var i=this,j="";$.each(h,function(l,m){if(m.category!=j){g.append("<li class='ui-autocompldete-category'><small><b> "+m.category+"<b></small></li>");j=m.category}i._renderItem(g,m)})}});var f=$("#searchEntry");f.catcomplete({search:function(){f.addClass("throbbing")},
source:function(g,h){var i=g.term.toUpperCase(),j=[];$.each(allPersons,function(l,m){(m.vorname+" "+m.name).toUpperCase().indexOf(i)>=0&&j.push({label:m.vorname+" "+m.name,category:"",value:"#"+m.id})});$.each(masterData.groups,function(l,m){if(groupView.isAllowedToSee(m.id))if(i=="GRUPPE:"||m.bezeichnung.toUpperCase().indexOf(i)>=0||("GRUPPE:"+m.bezeichnung.toUpperCase()).indexOf(i)>=0)j.push({label:m.bezeichnung,category:"Gruppe",value:"gruppe:"+m.bezeichnung})});$.each(masterData.tags,function(l,
m){if(i=="TAG:"||m.bezeichnung.toUpperCase().indexOf(i)>=0||("TAG:"+m.bezeichnung.toUpperCase()).indexOf(i)>=0)j.push({label:m.bezeichnung,category:"Tag",value:"tag:"+m.bezeichnung})});j.length==0&&j.indexOf("GRUPPE")==-1&&j.indexOf("TAG")==-1&&masterData.auth.write&&i.indexOf("#")==-1&&j.push({label:"Erstelle "+g.term,category:"",value:"CREATE:"+g.term});h(j);f.removeClass("throbbing")},select:function(g,h){if(h.item.value.indexOf("CREATE:")==0){h=h.item.value.substr(7,99).split(" ");g=h[0].substr(0,
1).toUpperCase()+h[0].substr(1);h=h[1];if(h!=null)h=h.substr(0,1).toUpperCase()+h.substr(1);e.renderAddEntry({vorname:g,name:h});window.setTimeout(function(){$("#searchEntry").val("");delete personView.filter.searchEntry},10)}else window.setTimeout(function(){$("#searchEntry").trigger("keyup")},10)}});$("#cdb_search a").click(function(){if($(this).attr("id")=="apersonview"){personView.furtherFilterVisible=e.furtherFilterVisible;churchInterface.setCurrentView(personView)}else if($(this).attr("id")==
"astatisticview"){statisticView.furtherFilterVisible=e.furtherFilterVisible;churchInterface.setCurrentView(statisticView)}else if($(this).attr("id")=="aviewmap"){mapView.furtherFilterVisible=e.furtherFilterVisible;churchInterface.setCurrentView(mapView)}else if($(this).attr("id")=="aarchiveview"){mapView.furtherFilterVisible=e.furtherFilterVisible;churchInterface.setCurrentView(archiveView)}churchInterface.getCurrentView().filter=e.filter;return false})};
a.renderAddEntry=function(e){var c='<div class="well"><div class="row-fluid">',f=this,g=new CC_Form("Name",e);g.surroundWithDiv("span4");g.addStandardField(masterData.fields.f_address.fields.vorname);g.addStandardField(masterData.fields.f_address.fields.name);g.addHtml('<p><a href="#" class="furtherfields">Weitere Felder hinzuf&uuml;gen</a>');g.addHtml('<div id="furtherfields" style="display:none">');$.each(masterData.fields,function(j,l){$.each(l.fields,function(m,n){n.inneuerstellen_yn==1&&g.addStandardField(n)})});
g.addHtml("</div>");c+=g.render();var h=new CC_Form("Kategorien");h.surroundWithDiv("span4");if(masterData.settings.newPersonBereich==null)masterData.settings.newPersonBereich=1;if(masterData.settings.newPersonStatus==null)masterData.settings.newPersonStatus=1;if(masterData.settings.newPersonStation==null)masterData.settings.newPersonStation=1;h.addSelect({data:masterData.auth.dep,selected:masterData.settings.newPersonBereich,cssid:"Inputf_dep",label:"Bereich"});h.addSelect({data:masterData.status,
selected:masterData.settings.newPersonStatus,cssid:"Inputf_status",label:"Status"});masterData.fields.f_category.fields.station_id!=null&&h.addSelect({data:masterData.station,selected:masterData.settings.newPersonStation,cssid:"Inputf_station",label:"Station"});c+=h.render();h=new CC_Form("Gruppen");h.surroundWithDiv("span4");if(masterData.groups!=null){var i=new Date;i.addDays(-1*masterData.groupnotchoosable);$.each(masterData.groupTypes,function(j,l){if(l.in_neue_person_erstellen_yn==1){var m=[];
$.each(masterData.groups,function(n,o){if(o.gruppentyp_id==l.id&&o.valid_yn==1&&o.versteckt_yn==0&&(o.abschlussdatum==null||o.abschlussdatum.toDateEn()>i))m.push(form_prepareDataEntry(o.id,o.bezeichnung))});h.addSelect({data:m,freeoption:true,cssid:"createGroup",label:l.bezeichnung})}})}c+=h.render();c+='</div><div class="row-fluid">';h=new CC_Form;h.surroundWithDiv("span12");h.addButton({label:"Person anlegen",controlgroup:true,cssid:"btProoveNewAddress"});h.addHtml("&nbsp; ");h.addCheckbox({cssid:"forceCreate",
controlgroup_start:true,label:"auch anlegen, wenn es den Namen schon gibt"});h.addCheckbox({cssid:"forceDontHide",controlgroup_end:true,label:"weitere Person anlegen"});c+=h.render(false,"vertical");c+="</div></div>";$("#divnewentry").html(c);$("#divnewentry a.furtherfields").click(function(){$(this).hide();$("#furtherfields").animate({height:"toggle"},"medium");return false});$("#divnewentry select").change(function(){var j="";if($(this).attr("id")=="Inputf_dep")j="newPersonBereich";else if($(this).attr("id")==
"Inputf_status")j="newPersonStatus";else if($(this).attr("id")=="Inputf_station")j="newPersonStation";churchInterface.jsonWrite({func:"saveSetting",sub:j,val:$(this).val()});masterData.settings[j]=$(this).val();j=$(this).val();if(masterData.groups[j]!=null){var l=groupView.getStatsOfGroup(j);if(masterData.groups[j].max_teilnehmer!=null&&masterData.groups[j].max_teilnehmer<=l.count_all_member){alert("Die Gruppe hat schon die maximale Anzahl von Teilnehmer erreicht, bitte andere Gruppe nehmen!");$(this).val("")}}});
$("#btProoveNewAddress").click(function(){var j=g.getAllValsAsObject(false);j.func="createAddress";if(j.vorname==null)j.vorname="";if(j.name==""){alert("Bitte Nachname angeben!");return false}$("#divnewentry select").each(function(){j[$(this).attr("id")]=$(this).val()});if($("#forceCreate").attr("checked")=="checked")j.force="checked";$.getJSON("index.php?q=churchdb/ajax",j,function(l){if(l.result=="exist"){$("#searchEntry").val(l.id).keyup();alert("Mindestens eine Person mit dem Namen existiert schon!")}else if(l.result!=
"ok")alert("Fehler aufgetreten: "+l.result);else{$("select[id=createGroup]").each(function(){$(this).val()>""&&f.addPersonGroupRelation(l.id,$(this).val())});cdb_loadPersonData(function(){f.filter={};f.filter.searchEntry="#"+l.id;if($("#forceDontHide").attr("checked")=="checked"){f.renderList();f.renderListMenu()}else f.renderView()},1,l.id)}})});$("#divnewentry").animate({height:"toggle"},"medium");window.setTimeout(function(){$("#divnewentry").find("#vorname").focus()},200)};
a.isPersonLeaderOfPerson=function(e,c){if(allPersons[c].gruppe==null)return false;var f=false;$.each(allPersons[c].gruppe,function(g,h){if(groupView.isPersonLeaderOfGroup(e,h.id)){f=true;return false}});return f};a.isPersonLeaderOfOneGroupTypeOfPerson=function(e,c,f){if(allPersons[f].gruppe==null)return false;var g=false;$.each(allPersons[f].gruppe,function(h,i){if(groupView.isGroupOfGroupType(i.id,c))if(groupView.isPersonLeaderOfGroup(e,i.id)){g=true;return false}});return g};
a.addPersonGroupRelation=function(e,c,f,g){var h=new Date,i=false;if(f==null)f=0;var j=groupView.getStatsOfGroup(c);if(masterData.groups[c].max_teilnehmer!=null&&masterData.groups[c].max_teilnehmer<=j.count_all_member){allPersons[e]!=null?alert("Gruppe "+masterData.groups[c].bezeichnung+" hat schon die maximale Anzahl von "+masterData.groups[c].max_teilnehmer+" Teilnehmern erreicht. "+allPersons[e].vorname+" "+allPersons[e].name+" konnte nicht zugewiesen werden!"):alert("Gruppe "+masterData.groups[c].bezeichnung+
" hat schon die maximale Anzahl von "+masterData.groups[c].max_teilnehmer+" Teilnehmern erreicht. Die Gruppe konnte der Person nicht zugewiesen werden!");return false}if(masterData.groups[c].followup_typ_id>0){alert('Followup "'+masterData.followupTypes[masterData.groups[c].followup_typ_id].bezeichnung+'" wurde gestartet!');churchInterface.jsonWriteSyncron({func:"addPersonGroupRelation",id:e,g_id:c,followup_count_no:1,followup_erfolglos_zurueck_gruppen_id:g,leader:f,date:h.toStringEn()},function(){i=
true})}else churchInterface.jsonWriteSyncron({func:"addPersonGroupRelation",id:e,g_id:c,leader:f,date:h.toStringEn()},function(){i=true});if(i){if(allPersons[e]==null)churchInterface.jsonReadSyncron({func:"getPersonDetails",id:e},function(l){allPersons[l.id]=cdb_mapJsonDetails(l,allPersons[l.id])});else{arr={};arr.id=c;arr.leiter=f;arr.d=(new Date).toStringEn();if(allPersons[e].gruppe==null)allPersons[e].gruppe={};allPersons[e].gruppe[arr.id]=arr}this.renderTodos();return true}else return false};
a.addSecondMenu=function(){rows=[];rows.push("<p></p>");if(this.filter["filterMeine Gruppen"]>0&&(groupView.isPersonLeaderOfGroup(masterData.user_pid,this.filter["filterMeine Gruppen"])||masterData.auth.write)){rows.push("<p>Gruppenfunktionen:&nbsp;");rows.push('|&nbsp;<a id="addtogroup" href="#">Person zur Gruppe hinzuf&uuml;gen</a>&nbsp; | &nbsp;');rows.push('<a id="delfromgroup" href="#">Markierte Person aus der Gruppe entfernen</a>&nbsp; | &nbsp;')}if(masterData.auth.write&&masterData.auth.editgroups){rows.push("<p>Personenfunktionen: Markierte Personen ... &nbsp;");
rows.push('<select id="personFunction"><option value="-1">');rows.push('<option value="addToGroup">... einer Gruppe hinzuf&uuml;gen');masterData.auth.viewtags&&rows.push('<option value="addPersonTag">... einen Tag hinzuf&uuml;gen');masterData.auth.adminpersons&&rows.push('<option value="addPersonAuth">... ein Zugriffssrecht hinzuf&uuml;gen');masterData.auth.adminpersons&&t.name=="PersonView"&&rows.push('<option value="archivePerson">... ins Archiv verschieben');rows.push("</select>")}return rows.join("")};
a.renderTooltip=function(e,c){function f(j){j=allPersons[j];h="<b>"+j.vorname+" "+j.name;if(j.geburtsdatum!=null)h=h+" ("+j.geburtsdatum.toDateEn().getAgeInYears()+")";h+="</b><br/>";if(masterData.auth.viewaddress||masterData.auth.viewalldetails)h=h+j.strasse+"<br/>";h=h+j.plz+" "+j.ort;h+="<br/><br/>";if(j.email!="")h=h+"E-Mail: "+j.email+"<br/>";if(j.telefonhandy!="")h=h+"Handy: "+j.telefonhandy+"<br/>";if(j.telefonprivat!="")h=h+"Telefon: "+j.telefonprivat+"<br/>";if(j.telefongeschaeftlich!="")h=
h+"Telefon Arbeit: "+j.telefongeschaeftlich+"<br/>";return h}var g=this,h="",i=e.attr("tooltip");if(i>0){h+=this.renderPersonImage(i);h='<br/><div class="tooltip_gesamt"><div class="tooltip_foto">'+h+'</div><div id="cdb_tooltipdetail" class="tooltip_address">';if(allPersons[i].details)h=h+f(i)+'</div><div style="clear:both"></div></div>';else{h+='Lade Daten..</div><div style="clear:both"></div></div>';churchInterface.jsonRead({func:"getPersonDetails",id:i},function(j){if(j!="no access"){allPersons[j.id]=
cdb_mapJsonDetails(j,allPersons[j.id]);g.renderTooltip2Div(e,c);h=null}else $("#cdb_tooltipdetail").html("<i>Keine Berechtigung</i>")})}return[h,""]}else if(i==-1){h="<p>";i=g.getMeetingFromMeetingList(e.attr("data-group-id"),e.attr("data-gruppentreffen-id"));if(i!=null){if(i.kommentar!=null){h=h+'<div class="well"><i>Kommentar: </i><br><small><i>'+i.kommentar;h=h+"<p>"+i.modified_date.toDateEn(false).toStringDe(false);h=allPersons[i.modified_pid]!=null?h+" "+allPersons[i.modified_pid].vorname+" "+
allPersons[i.modified_pid].name+"":h+" ["+i.modified_pid+"]";h+="</i></small></div>"}else h+="Kein Kommentar vorhanden";if(i.anzahl_gaeste!=null)h=h+"<p>Anzahl G&auml;ste: "+i.anzahl_gaeste;h=h+"<p>"+form_renderButton({label:"Editieren",htmlclass:"edit btn-success",type:"small"})+" ";h=h+""+form_renderButton({label:"Entfernen",htmlclass:"delete btn-danger",type:"small"});h+=form_renderHidden({cssid:"data-group-id",value:e.attr("data-group-id")});h+=form_renderHidden({cssid:"data-datum",value:e.attr("data-datum")});
h+=form_renderHidden({cssid:"data-gruppentreffen-id",value:i.id});return[h]}}};a.getMeetingFromMeetingList=function(e,c){var f=null;$.each(masterData.groups[e].meetingList,function(g,h){if(h.id==c){f=h;return false}});return f};
a.tooltipCallback=function(e,c){var f=this;c.find("input.delete").click(function(){f.clearTooltip(true);var g=$("#data-group-id").val();confirm("Wirklich das Treffen vom "+$("#data-datum").val().toDateEn(true).toStringDe()+" entfernen?")&&churchInterface.jsonWrite({func:"GroupMeeting",sub:"delete",id:$("#data-gruppentreffen-id").val()},function(h){h&&cdb_loadGroupMeetingStats(churchInterface.getCurrentView().filter,g,function(){masterData.groups[g].meetingList=null;personView.renderList()})})});c.find("input.edit").click(function(){f.clearTooltip(true);
f.editMeetingProperties($("#data-group-id").val(),$("#data-gruppentreffen-id").val())})};
a.editMeetingProperties=function(e,c){var f=this,g=f.getMeetingFromMeetingList(e,c);if(g!=null){var h=new CC_Form;h.addInput({label:"Anzahl G&auml;ste",value:g.anzahl_gaeste,cssid:"anzahl_gaeste"});h.addTextarea({label:"Kommentar",rows:4,data:g.kommentar,placeholder:"Kommentar",cssid:"kommentar"});form_showDialog("Treffen editieren",h.render(null,"vertical"),300,350,{Speichern:function(){var i=h.getAllValsAsObject();i.func="GroupMeeting";i.sub="saveProperties";i.id=c;i.g_id=e;var j=$.extend({},g);
g.kommentar=i.kommentar;g.anzahl_gaeste=i.anzahl_gaeste;if(g.anzahl_gaeste=="")g.anzahl_gaeste=0;churchInterface.jsendWrite(i,function(l){if(!l){alert("Es gab ein Fehler beim Speichern!");g=j;f.renderList()}});f.renderList();$(this).dialog("close")},Abbruch:function(){$(this).dialog("close")}})}else alert("Treffen nicht gefunden!?")};
a.addFurtherListCallbacks=function(e){var c=this;$("#cdb_content a").click(function(f){if($(this).attr("id")==null)return true;else if($(this).attr("id")=="addtogroup")c.renderPersonSelect("Nach einer Person suchen",true,function(i){delete c.filter.searchEntry;c.addPersonGroupRelation(i,c.filter["filterMeine Gruppen"]);c.renderList()});else if($(this).attr("id").indexOf("contact")==0){c.showcontact=$(this).attr("id").substr(7,99);c.renderList()}else if($(this).attr("id")=="delfromgroup"){usernames=
"";ids="-1";$.each(allPersons,function(i,j){if(c.checkFilter(j)&&j.checked){usernames=usernames+j.vorname+" "+j.name+", ";ids=ids+","+j.id}});if(usernames=="")alert("Bitte entsprechenden Eintrag markieren");else confirm("Wirklich "+usernames+" aus '"+masterData.groups[c.filter["filterMeine Gruppen"]].bezeichnung+"' entfernen?")&&$.each(allPersons,function(i,j){if(c.checkFilter(j)&&j.checked){c.delPersonFromGroup(j.id,c.filter["filterMeine Gruppen"],true);j.checked=false}})}else if($(this).attr("id")==
"mailto")return true;else if($(this).attr("id").indexOf("groupinfos")==0){churchInterface.setCurrentView(groupView);groupView.clearFilter();masterData.auth.viewalldata?groupView.setFilter("searchEntry",$(this).attr("href").substring(1,99)):groupView.setFilter("filterMeine Gruppen",$(this).attr("href").substring(1,99));groupView.renderView()}else if($(this).attr("id").indexOf("search_tag")==0){c.setFilter("searchEntry","tag:"+$(this).attr("id").substr(10,99));f.open=false;c.renderView();return false}else if($(this).attr("id")==
"closeGruppenteilnahme"){masterData.settings.selectedGroupType=churchcore_getFirstElement(masterData.groupTypes).id;churchInterface.jsonWrite({func:"saveSetting",sub:"selectedGroupType",val:masterData.settings.selectedGroupType});r.renderView()}else if($(this).attr("id")=="editGruppentreffenProperties"){c.clearTooltip(true);c.editMeetingProperties($(this).attr("data-group-id"),$(this).attr("data-gruppentreffen-id"))}else if($(this).attr("id")=="addGruppenteilnehmerdatum"){var g=new CC_Form("Event hinzuf&uuml;gen");
g.addInput({label:"Datum",value:(new Date).toStringDe(false)});g.addInput({label:"Uhrzeit",value:"10:00"});var h=form_showDialog("Gruppenteilnahme",g.render(),400,400,{Speichern:function(){var i=g.getAllValsAsObject();i.datumvon=i.Datum.toDateDe().toStringEn(false)+" "+i.Uhrzeit;i.datumbis=i.datumvon;i.gruppe_id=c.filter["filterMeine Gruppen"];i.func="addEvent";churchInterface.jsendWrite(i,function(){h.dialog("close");c.loadGroupMeetingList(c.filter["filterMeine Gruppen"])})},Abbruch:function(){$(this).dialog("close")}})}});
e=="#cdb_content"&&$("#cdb_content span.clickyesno").click(function(){var f=c.getMeetingFromMeetingList(c.filter["filterMeine Gruppen"],$(this).attr("data-gruppentreffen-id")),g=$(this).attr("data-person-id"),h=null;$.each(f.entries,function(j,l){if(l.p_id==g){h=j;return false}});var i={};if(h==null){f.entries.push({p_id:g,treffen_yn:1});i.treffen_yn=1}else{f.entries[h].treffen_yn=f.entries[h].treffen_yn==1?0:1;i.treffen_yn=f.entries[h].treffen_yn}f.eintragerfolgt_yn=1;i.func="GroupMeeting";i.sub=
"editCheckin";i.gruppentreffen_id=$(this).attr("data-gruppentreffen-id");i.p_id=g;churchInterface.jsonWrite(i);c.renderList();c.renderGroupContent(c.filter["filterMeine Gruppen"]);return false});$("#cdb_content select").change(function(){if(this.id=="filterGruppentyp"){var f=masterData.settings.selectedGroupType;masterData.settings.selectedGroupType=$(this).val();churchInterface.jsonWrite({func:"saveSetting",sub:"selectedGroupType",val:$(this).val()});if(masterData.settings.selectedGroupType==-4&&
c.filter["filterMeine Gruppen"]==null){alert('Bitte erst eine Gruppe unter "Meine Filter" einstellen');masterData.settings.selectedGroupType=f}else c.renderGroupEntry();c.renderList()}else if(this.id=="personFunction"){c.personFunction(this.value);$(this).val(-1)}})};
a.personFunction=function(e,c){var f=this,g=[];$.each(allPersons,function(j,l){l.checked&&g.push(l.id)});if(g.length==0)alert("Bitte Personen markieren um diese Funktion zu nutzen!");else{var h=new CC_Form;if(e=="addToGroup"){h.setLabel("Bitte Gruppe ausw&auml;hlen");h.addSelect({freeoption:true,label:"Gruppentyp",data:masterData.groupTypes,cssid:"inputGruppentyp",selected:c});c>0&&h.addSelect({label:"Gruppe",data:masterData.groups,cssid:"inputId",func:function(j){return j.gruppentyp_id==c}})}else if(e==
"addPersonTag"){h.setLabel("Bitte Tag ausw&auml;hlen");h.addSelect({freeoption:false,label:"Tag",data:masterData.tags,cssid:"inputId"})}else if(e=="addPersonAuth"){h.setLabel("Bitte Zugriffsrecht ausw&auml;hlen");h.addSelect({label:"Zugriffsrecht",data:getAuthAsDataArray(false),cssid:"inputId",sort:false,selected:f.filter.filterAuth})}else if(e=="archivePerson"){h.setLabel("Personen archivieren");h.addHtml("Hiermit werden die markierten Personen in das Archiv verschieben. Diese sind dann nur noch mit speziellen Rechten sichtbar!");
h.addHidden({cssid:"inputId",value:"dummy"})}h.addCheckbox({cssid:"delChecked",label:"Markierung bei den "+g.length+" Personen wieder entfernen?"});var i=f.showDialog("Mehrere hinzuf&uuml;gen...",h.render(),500,350,{Speichern:function(){function j(o,p){if(o[p]!=null)window.setTimeout(function(){if(e=="addToGroup")f.addPersonGroupRelation(o[p],l);else if(e=="addPersonTag"){if(allPersons[o[p]].tags==null)allPersons[o[p]].tags=[];if(!churchcore_inArray(l,allPersons[o[p]].tags)){allPersons[o[p]].tags.push(l);
churchInterface.jsonWrite({func:"addPersonTag",id:o[p],tag_id:l})}}else if(e=="addPersonAuth"){m.id=o[p];if(allPersons[o[p]].auth==null)allPersons[o[p]].auth={};allPersons[o[p]].auth[l]=l;m.auth_id=l;churchInterface.jsonWriteSyncron(m)}else if(e=="archivePerson"){m.id=o[p];if(allPersons[o[p]].archiv_yn==0){allPersons[o[p]].archiv_yn=1;churchInterface.jsonWriteSyncron(m)}}i.find("div.bar").width(100*(p+1)/o.length+"%");j(o,p+1)},10);else{i.dialog("close");f.renderList()}}var l=$("#inputId").val(),
m={},n=$("#delChecked").attr("checked")=="checked";m.func=e;if(l==null){alert("Bitte Eintrag selektieren!");return false}i.html('<legend>Fortschritt</legend><div class="progress progress-striped active"><div class="bar" style="width: 0%;"></div></div>');j(g,0);n&&$.each(allPersons,function(o,p){allPersons[p.id].checked=null})},Abbruch:function(){$(this).dialog("close")}});i.find("#inputGruppentyp").change(function(){i.dialog("close");f.personFunction(e,$(this).val())})}};
a.renderListEntry=function(e){var c=this;rows=[];var f="status_";if(masterData.status[e.status_id]!=null){f+=masterData.status[e.status_id].kuerzel.toLowerCase();if(masterData.status[e.status_id].mitglied_yn==1)f+=" member"}rows.push('<td><a href="" class="'+f+'" tooltip="'+e.id+'" id="detail'+e.id+'">'+e.vorname);e.spitzname!=""&&rows.push(" ("+e.spitzname+")");rows.push('</a><td><a href="" class="'+f+'" tooltip="'+e.id+'" id="detail'+e.id+'">'+e.name+"</a>");if(masterData.settings.selectedGroupType!=
-4){rows[rows.length]=c.showcontact=="email"?e.email!=null&&e.email!=""?'<td class="hidden-phone"><a id="mailto" href="mailto:'+e.email+'">'+e.email+"</a>":e.tel!=null&&e.tel!=""?'<td class="hidden-phone"><a href="tel:'+e.tel+'">'+e.tel+"</a>":'<td class="hidden-phone">-':e.tel!=null&&e.tel!=""?'<td class="hidden-phone"><a href="tel:'+e.tel+'">'+e.tel+"</a>":'<td class="hidden-phone">-';rows[rows.length]='<td class="hidden-phone">'}else if(masterData.groups!=null&&masterData.groups[c.filter["filterMeine Gruppen"]]!=
null){masterData.groups[c.filter["filterMeine Gruppen"]].meetingList!=null&&masterData.groups[c.filter["filterMeine Gruppen"]].meetingList!="get data"&&$.each(masterData.groups[c.filter["filterMeine Gruppen"]].meetingList,function(m,n){if(n.datumvon.toDateEn(false).getFullYear()==c.gruppenteilnehmerdatum.getFullYear()&&n.datumvon.toDateEn(false).getMonth()==c.gruppenteilnehmerdatum.getMonth()){rows.push('<td><span class="clickyesno" data-person-id="'+e.id+'" data-gruppentreffen-id="'+n.id+'">');var o=
false;$.each(n.entries,function(p,q){if(q.p_id==e.id){o=true;rows.push(c.renderYesNo(q.treffen_yn,18))}});o||rows.push(form_renderImage({src:"question.png",width:18}))}});rows.push("<td>")}if(masterData.settings.selectedGroupType==-2){if(e.tags!=null){var g=true;$.each(e.tags,function(m,n){if(g)g=false;else rows.push(", ");rows.push(c.renderTag(n,false))})}}else if(masterData.settings.selectedGroupType==-3){if(e.auth!=null){var h=[];$.each(e.auth,function(m){h.push(c.renderAuth(m))});h.length>0&&
rows.push("<b>Direkte Rechte: </b>"+h.join(",")+"<br/>")}if(e.gruppe!=null){h={};$.each(e.gruppe,function(m,n){n.leiter>=0&&masterData.groups[n.id].auth!=null&&$.each(masterData.groups[n.id].auth,function(o){h[o]=o})});if(churchcore_countObjectElements(h)>0){rows.push("<b>Rechte durch Gruppen: </b>");var i=[];$.each(h,function(m,n){i.push(c.renderAuth(n))});rows.push(i.join(", "),"<br/>")}}if(masterData.status[e.status_id].auth!=null){h=[];$.each(masterData.status[e.status_id].auth,function(m){h.push(c.renderAuth(m))});
h.length>0&&rows.push("<b>Rechte durch Status: </b>"+h.join(",")+"<br/>")}}else if(e.gruppe!=null){var j=0;$.each(e.gruppe,function(m,n){if(masterData.groups[n.id]!=null&&groupView.isGroupOfGroupType(n.id,masterData.settings.selectedGroupType)&&groupView.isAllowedToSee(n.id)){if(j>0)rows[rows.length]=", ";m="";if(n.leiter==1||n.leiter==2)m="font-weight:bold;";else if(n.leiter==3)m="font-weight:bold;color:gray";else if(n.leiter==-1)m="color:gray;text-decoration:line-through;";else if(n.leiter==-2)m=
"color:#3a87ad;";rows[rows.length]='<a href="#'+n.id+'" id="groupinfos'+e.id+'" style="'+m+'">';rows[rows.length]=masterData.groups[n.id].bezeichnung.trim(25);n.leiter==-2&&rows.push("?");if(masterData.groupMemberTypes[n.leiter].kuerzel!="")rows[rows.length]=" ("+masterData.groupMemberTypes[n.leiter].kuerzel+")";if(masterData.groups[n.id].followup_typ_id>0&&n.followup_count_no!=null){m=_getPersonGroupFollowupDiffDays(n);var o="";if(m<0)o="red";else if(m<7)o="green";rows.push(' <small>(<i><font color="'+
o+'">Step '+n.followup_count_no+", "+m+"T.</font></i>)</small>")}if(groupMeetingStats!=null&&groupMeetingStats[e.id]!=null&&groupMeetingStats[e.id][n.id]!=null){val=Math.round(groupMeetingStats[e.id][n.id].dabei/groupMeetingStats[e.id][n.id].stattgefunden*100);valtxt=val<50?'<font color="red">'+val+"%</font>":val+"%";rows.push("&nbsp;<small>"+valtxt+" ");if(val>0){date=groupMeetingStats[e.id][n.id].datum.toDateEn();now=new Date;now-date>2592E6&&rows.push('/ <font color="red">'+date.toStringDe()+"</font>")}rows.push("</small>")}rows[rows.length]=
"</a>";j++}})}if(masterData.settings.selectedGroupType!=-4){if(masterData.auth.viewalldetails){rows[rows.length]='<td class="hidden-phone">';e.status_id!=null&&masterData.status[e.status_id]!=null?rows.push('<font title="'+masterData.status[e.status_id].bezeichnung+'">'+masterData.status[e.status_id].kuerzel+"</font>"):rows.push("Id:"+e.status_id+"?")}if(masterData.fields.f_category.fields.station_id!=null){rows[rows.length]='<td class="hidden-phone">';e.status_id!=null&&masterData.station[e.station_id]!=
null&&rows.push('<font title="'+masterData.station[e.station_id].bezeichnung+'">'+masterData.station[e.station_id].kuerzel+"</font>")}var l="";if(e.access!=null){l+='<font title="';$.each(e.access,function(m){l=l+masterData.dep[m].bezeichnung+" "});l+='">';$.each(e.access,function(m){l+=masterData.dep[m].kuerzel});l+="</font>"}rows[rows.length]='<td class="hidden-phone">'+l}return rows.join("")};
a.makeFilterStatus=function(e,c,f){var g=this,h="filter"+e;if(f==null)f=masterData[e.toLowerCase()];g.filter[h]=new CC_MultiSelect(f,function(){masterData.settings[h]=this.getSelectedAsArrayString();churchInterface.jsonWrite({func:"saveSetting",sub:h,val:masterData.settings[h]});g.renderList()});g.filter[h].setSelectedAsArrayString(c);e=="Status"&&g.filter[h].addFunction("Mitglieder ausw&auml;hlen",function(i){return i.mitglied_yn==1})};
a.createMultiselect=function(e,c){var f="filter"+e;if(masterData.settings[f]==""||masterData.settings[f]==null)delete masterData.settings[f];this.filter[f]==null&&this.makeFilterStatus(e,masterData.settings[f],c);this.filter[f].render2Div(f,{label:e})};
a.getListHeader=function(){var e=this,c=e.filter["filterMeine Gruppen"];if(this.filter.searchEntry!=null&&this.filter.searchEntry>0&&allPersons[this.filter.searchEntry]==null){allPersons[this.filter.searchEntry]={};allPersons[this.filter.searchEntry].id=this.filter.searchEntry}e.createMultiselect("Status",masterData.status);e.createMultiselect("Station",masterData.station);e.createMultiselect("Bereich",masterData.auth.dep);tableHeader='<th><a href="#" id="sortid">Nr.</a><th><a href="#" id="sortvorname">'+
masterData.fields.f_address.fields.vorname.text+'</a><th><a href="#" id="sortname">'+masterData.fields.f_address.fields.name.text+"</a>";if(masterData.settings.selectedGroupType==null)masterData.settings.selectedGroupType=3;if(masterData.settings.selectedGroupType!=-4)tableHeader+='<th class="hidden-phone"><a href="#" id="contactemail">EMail</a> / <a href="#" id="contacttel">Telefon</a>';if(masterData.settings.selectedGroupType>-2)if(masterData.groupTypes[masterData.settings.selectedGroupType]==null||
!masterData.auth.viewalldata&&masterData.groupTypes[masterData.settings.selectedGroupType].anzeigen_in_meinegruppen_teilnehmer_yn==0)masterData.settings.selectedGroupType=-1;if(masterData.settings.selectedGroupType!=-4){var f=jQuery.extend({},masterData.groupTypes);if(masterData.auth.viewtags){var g={};g.id=-2;g.bezeichnung="Tags";f[-2]=_createEntry(-2,"Tags")}if(masterData.auth.adminpersons){g={};g.id=-3;g.bezeichnung="Zugriffsrechte";f[-3]=_createEntry(-3,"Zugriffsrechte")}if(masterData.auth.viewgroupstats||
e.filter["filterMeine Gruppen"]!=null&&groupView.isPersonLeaderOfGroup(masterData.user_pid,e.filter["filterMeine Gruppen"])){g={};g.id=-4;g.bezeichnung="Gruppenteilnahme";f[-4]=_createEntry(-4,"Gruppenteilnahme")}tableHeader+='<th class="hidden-phone">';tableHeader+=form_renderSelect({data:f,controlgroup:false,cssid:"filterGruppentyp",type:"medium",selected:masterData.settings.selectedGroupType,func:function(h){return h.id==-2||h.anzeigen_in_meinegruppen_teilnehmer_yn==1||masterData.auth.viewalldata}})}if(masterData.settings.selectedGroupType==
-4){masterData.groups!=null&&masterData.groups[c]!=null&&masterData.groups[c].meetingList!=null&&$.each(masterData.groups[c].meetingList,function(h,i){if(i.datumvon!=null&&i.datumvon.toDateEn(false).getFullYear()==e.gruppenteilnehmerdatum.getFullYear()&&i.datumvon.toDateEn(false).getMonth()==e.gruppenteilnehmerdatum.getMonth()){h=i.datumvon.toDateEn(true);tableHeader=tableHeader+'<th><span tooltip="-1" data-tooltiptype="gruppenteilnahme" data-gruppentreffen-id="'+i.id+'" data-group-id="'+c+'" data-datum="'+
i.datumvon+'">'+h.getDate()+"."+(h.getMonth()+1)+".";if(h.getHours()!=0)tableHeader=tableHeader+" <small>"+h.getHours()+":"+((h.getMinutes()+"").length==1?"0"+h.getMinutes():h.getMinutes())+"h</small><br>";tableHeader=tableHeader+form_renderImage({cssid:"editGruppentreffenProperties",src:i.kommentar==null?"comment_sw.png":i.kommentar!=""?"comment.png":"check-64.png",width:16,data:[{name:"gruppentreffen-id",value:i.id},{name:"group-id",value:c}]})+"&nbsp;";var j=0;i.entries!=null&&$.each(i.entries,
function(l,m){m.treffen_yn==1&&j++});tableHeader=tableHeader+" <small>"+j+" </small>"+form_renderImage({src:"person.png",label:"Anzahl Teilnehmer",width:12});if(i.anzahl_gaeste!=null)tableHeader=tableHeader+" <small>"+i.anzahl_gaeste+" </small>"+form_renderImage({src:"person_sw.png",label:"Anzahl G&auml;ste",width:12});tableHeader+="</span>"}});if(c!=null)tableHeader=tableHeader+"<th>"+form_renderImage({src:"plus.png",width:16,title:"Weiteres Datum hinzuf&uuml;gen",cssid:"addGruppenteilnehmerdatum"});
e.renderGroupEntry()}if(masterData.settings.selectedGroupType!=-4){if(masterData.auth.viewalldetails)tableHeader+='<th class="hidden-phone"><a href="#" id="sortstatus_id" title="Status">S';if(masterData.fields.f_category.fields.station_id!=null)tableHeader+='<th class="hidden-phone"><a href="#" id="sortstation_id" title="Station">S';tableHeader+='<th class="hidden-phone"><font title="Bereich">B</font>'}return tableHeader};
a.msg_allDataLoaded=function(e){var c=0;$.each(allPersons,function(f,g){g.gruppe!=null&&$.each(g.gruppe,function(h,i){_isFollowUpGroup(i)&&groupView.isPersonLeaderOfGroup(masterData.user_pid,i.id)&&_getPersonGroupFollowupDiffDays(i)<0&&c++})});if(c>0){if(masterData.settings.automaticActivateFollowupOverdue==null||masterData.settings.automaticActivateFollowupOverdue==1)this.filter.followupOverdue=true;e=true}this.filter["filterMeine Gruppen"]>0&&churchInterface.getCurrentView()==personView&&this.renderGroupEntry();
if(churchInterface.getCurrentView()==personView){e&&churchInterface.getCurrentView().renderList();churchInterface.getCurrentView().renderTodos()}};
a.messageReceiver=function(e,c){if(this==churchInterface.getCurrentView())if(e=="allDataLoaded")this.msg_allDataLoaded(c[0]);else if(e=="filterChanged")this.msg_filterChanged(c[0],c[1]);else if(e=="pollForNews"){var f=false;$.each(c,function(g,h){if(h.domain_type=="person"&&h.schreiben_yn==1&&h.domain_id!=-1){if(masterData.auth.viewalldata)allPersons[h.domain_id]!=null?churchInterface.setStatus("<small>"+h.datum.toDateEn(true).getHours()+":"+h.datum.toDateEn(true).getMinutes()+" - "+h.userid+" hat "+
allPersons[h.domain_id].vorname+allPersons[h.domain_id].name+" editiert.</small>",true):churchInterface.setStatus("<small>"+h.datum.toDateEn(true).getHours()+":"+h.datum.toDateEn(true).getMinutes()+" - "+h.userid+" hat eine neue Person angelegt.</small>",true);if(allPersons[h.domain_id]==null||allPersons[h.domain_id].details){churchInterface.jsonReadSyncron({func:"getPersonDetails",id:h.domain_id},function(i){allPersons[i.id]=cdb_mapJsonDetails(i,allPersons[i.id]);f=true});if(allPersons[h.domain_id]!=
null&&allPersons[h.domain_id].inEdit!=null){allPersons[h.domain_id].inEdit.empty().remove();allPersons[h.domain_id].inEdit=null;alert("Achtung, die Person wurde eben von '"+h.userid+"' editiert, Daten werden nun neu geladen!")}}}});f&&this.renderList()}else alert("Message "+e+" unbekannt!")};
a.renderTodos=function(){var e=this;if(e.currentTodoTimer==null)e.currentTodoTimer=window.setTimeout(function(){var c=0,f=0,g=0,h=0,i=[];$.each(allPersons,function(l,m){m!=null&&m.gruppe!=null&&$.each(m.gruppe,function(n,o){if(_isFollowUpGroup(o)&&groupView.isPersonLeaderOfGroup(masterData.user_pid,o.id)){n=_getPersonGroupFollowupDiffDays(o);if(n<0)f++;else n<14&&c++}o.leiter==-2&&groupView.isPersonLeaderOfGroup(masterData.user_pid,o.id)&&g++;o.leiter==-1&&groupView.isPersonLeaderOfGroup(masterData.user_pid,
o.id)&&h++})});var j=false;if(c==0)j=j||e.deleteFilter("followupToday");if(f==0)j=j||e.deleteFilter("followupOverdue");if(g==0)j=j||e.deleteFilter("groupSubscribe");if(h==0)j=j||e.deleteFilter("groupDelete");j&&e.renderList();if(c>0||f>0||g>0||h>0){j=new CC_Form;j.surroundWithDiv("well");j.setHelp("ChurchDB-Aufgaben");j.addHtml("<p>Meine Aufgaben</p>");f>0&&j.addCheckbox({controlgroup:false,controlgroup_class:"s",checked:e.getFilter("followupOverdue"),cssid:"followupOverdue",label:'&uuml;berf&auml;llige FollowUps <span class="pull-right badge badge-warning">'+
f+"</span>"});c>0&&j.addCheckbox({controlgroup:false,controlgroup_class:"s",checked:e.getFilter("followupToday"),cssid:"followupToday",label:'n&auml;chste FollowUps <span class="pull-right badge badge-success">'+c+"</span>"});g>0&&j.addCheckbox({controlgroup:false,controlgroup_class:"s",checked:e.getFilter("groupSubscribe"),cssid:"groupSubscribe",label:'Antrag Gruppenteilnahme &nbsp;<span class="pull-right badge badge-info">'+g+"</span>"});h>0&&j.addCheckbox({controlgroup:false,controlgroup_class:"s",
checked:e.getFilter("groupDelete"),cssid:"groupDelete",label:'L&oumlschung Gruppenteilnahme &nbsp;<span class="pull-right badge badge-important">'+h+"</span>"});i.push(j.render())}else if(e.filter.followupToday!=null||e.filter.followupOverdue!=null){alert("Vielen Dank! Followup ist heute abgeschlossen.");delete e.filter.followupToday;delete e.filter.followupOverdue}$("#cdb_todos").html(i.join(""));e.implantStandardFilterCallbacks(this,"cdb_todos");e.currentTodoTimer=null},50)};
a.renderFilter=function(){var e=this,c=[],f=new CC_Form;f.setHelp("ChurchDB-Filter");var g=e.getMyGroupsSelector(true),h="";if(masterData.auth.viewalldata){h="&nbsp; "+form_renderImage({label:"Aktuelle Filter als intelligente Gruppe speichern",cssid:"saveMyFilter",src:masterData.modulespath+"/images/save.png",htmlclass:"small"});if(typeof this.filter["filterMeine Gruppen"]=="string"&&this.filter["filterMeine Gruppen"].indexOf("filter")==0)h+=form_renderImage({label:"Intelligente Gruppe entfernen",
cssid:"delIntelligentGroup",src:masterData.modulespath+"/images/trashbox.png",htmlclass:"small"})}f.addSelect({data:g,label:"Meine Gruppen",sort:false,cssid:"filterMeine Gruppen",selected:personView.filter["filterMeine Gruppen"],type:"medium",html:h});masterData.auth.viewalldetails&&f.addHtml('<div id="filterStatus"></div>');masterData.fields.f_category.fields.station_id!=null&&f.addHtml('<div id="filterStation"></div>');f.addHtml('<div id="filterBereich"></div>');f.addCheckbox({cssid:"searchChecked",
label:"markierte"});c.push(f.render(true,"inline"));$("#cdb_filter").html(c.join(""));if(this.filter.filterStatus!=null){typeof this.filter.filterStatus=="string"&&e.makeFilterStatus("Status",masterData.settings.filterStatus);this.filter.filterStatus.render2Div("filterStatus",{label:"Status"})}if(this.filter.filterStaton!=null){typeof this.filter.filterStation=="string"&&e.makeFilterStatus("Station",masterData.settings.filterStation);this.filter.filterStation.render2Div("filterStation",{label:"Station"})}if(this.filter.filterBereich!=
null){typeof this.filter.filterBereich=="string"&&e.makeFilterStatus("Bereich",masterData.settings.filterBereich,masterData.auth.dep);this.filter.filterBereich.render2Div("filterBereich",{label:"Bereich"})}$.each(this.filter,function(i,j){$("#"+i).val(j)});this.implantStandardFilterCallbacks(this,"cdb_filter");e=this;$("#cdb_filter a").click(function(){if($(this).attr("id")=="atoggleViews"){$("#cdb_search").toggle();e.renderFilter();return false}else if($(this).attr("id")=="delIntelligentGroup"){if(confirm("Wirklich die intelligente Gruppen "+
e.filter["filterMeine Gruppen"].substr(6,99)+" entfernen?")){churchInterface.jsonWrite({func:"delMyFilter",name:e.filter["filterMeine Gruppen"].substr(6,99)});delete masterData.settings.filter[e.filter["filterMeine Gruppen"].substr(6,99)];delete e.filter["filterMeine Gruppen"];masterData.settings.selectedMyGroup=null;churchInterface.jsonWrite({func:"saveSetting",sub:"selectedMyGroup",val:"null"});e.resetPersonFilter();e.resetGroupFilter();e.renderFilter();e.renderFurtherFilter();e.renderList()}}else if($(this).attr("id")==
"saveMyFilter"){var i=[];i.push("Bitte einen Namen f&uuml;r die intelligente Gruppe eingeben<br/>");i.push('Name: <input type="text" id="inputName" class="cdb-textfield"><br/><br/>');i.push('<small><i>Die aktuelle Filtereinstellung kann als "intelligente Gruppe" abgespeichert werden. Diese Gruppe enth&auml;lt dann keine festen Verbindung zu Personen, sondern beim Aufruf werden alle Personen gefiltert, die zu dieser Gruppe passen. Der Aufruf ist dann &uuml;ber "Meine Gruppen" m&ouml;glich.</i></small><br/><br/>');
e.showDialog("Filter speichern",i.join(""),400,400,{Speichern:function(){var j=$("#inputName").val();e.filter.filterStatus=e.filter.filterStatus.getSelectedAsArrayString();e.filter.filterStation=e.filter.filterStation.getSelectedAsArrayString();e.filter.filterBereich=e.filter.filterBereich.getSelectedAsArrayString();churchInterface.jsonWriteSyncron({func:"saveMyFilter",name:j,filter:e.filter});e.makeFilterStatus("Status",masterData.settings.filterStatus);e.makeFilterStatus("Station",masterData.settings.filterStation);
e.makeFilterStatus("Bereich",masterData.settings.filterBereich,masterData.auth.dep);e.filter["filterMeine Gruppen"]="filter"+j;e.furtherFilterVisible=false;cdb_loadMasterData(function(){e.renderFilter();e.renderFurtherFilter();listOffset=0;e.renderList()});$(this).dialog("close")},Abbruch:function(){$(this).dialog("close")}});return renderList=false}})};
function _checkGroupFilter(e,c,f){function g(i,j){if(c["filterGruppeInAb "+i]!=null&&j.d.toDateEn()<c["filterGruppeInAb "+i].toDateDe())return false;if(c["filterGruppeInSeit "+i]!=null&&j.d.toDateEn()>c["filterGruppeInSeit "+i].toDateDe())return false;return true}if(c["filterFilter "+f]==null||c["filterFilter "+f]==0){var h=true;if(c["filterTyp "+f]!=null&&c["filterTyp "+f]!=""){if(e.gruppe==null)return false;h=false;$.each(e.gruppe,function(i,j){if(c["filterTyp "+f]==masterData.groups[j.id].gruppentyp_id)h=
g(f,j)});if(!h)return false}if(c["filterGruppe "+f]!=null){if(e.gruppe==null)return false;h=false;$.each(e.gruppe,function(i,j){if(c["filterGruppe "+f]!=null&&c["filterGruppe "+f]!="")if(j.id==c["filterGruppe "+f])h=g(f,j)});if(!h)return false}if(c["filterDistrikt "+f]!=null&&c["filterDistrikt "+f]!="")if(e.gruppe==null)return false;else{h=false;$.each(e.gruppe,function(i,j){if(masterData.groups[j.id]!=null&&masterData.groups[j.id].distrikt_id==c["filterDistrikt "+f])h=g(f,j)});if(!h)return false}if(c["filterTeilnehmerstatus "+
f]!=null)if(e.gruppe==null)return false;else{h=false;$.each(e.gruppe,function(i,j){if(c["filterTyp "+f]==""||c["filterTyp "+f]==masterData.groups[j.id].gruppentyp_id)if(c["filterGruppe "+f]==null||c["filterGruppe "+f]==j.id)if(c["filterDistrikt "+f]==null||c["filterDistrikt "+f]==masterData.groups[j.id].distrikt_id)if(j.leiter==c["filterTeilnehmerstatus "+f])h=g(f,j)});if(!h)return false}}else if(c["filterFilter "+f]!=null&&c["filterFilter "+f]==1){if(e.gruppe!=null){h=false;$.each(e.gruppe,function(i,
j){if(c["filterTyp "+f]!="")if(masterData.groups[j.id].gruppentyp_id==c["filterTyp "+f])if(c["filterTeilnehmerstatus "+f]!=null){if(c["filterTeilnehmerstatus "+f]==j.leiter)h=true}else h=true;if(c["filterGruppe "+f]!=null&&c["filterGruppe "+f]!=""){if(j.id==c["filterGruppe "+f])if(c["filterTeilnehmerstatus "+f]!=null){if(c["filterTeilnehmerstatus "+f]==j.leiter)h=true}else h=true}else if(c["filterDistrikt "+f]!=null&&c["filterDistrikt "+f]!=""){if(masterData.groups[j.id].distrikt_id==c["filterDistrikt "+
f])if(c["filterTeilnehmerstatus "+f]!=null){if(c["filterTeilnehmerstatus "+f]==j.leiter)h=true}else h=true}else if(c["filterTeilnehmerstatus "+f]!=null){if(c["filterTeilnehmerstatus "+f]==j.leiter)h=true}else h=true});if(h)return false}}else if(c["filterFilter "+f]!=null&&c["filterFilter "+f]==2){h=false;if(e.oldGroups!=null){arr2={};$.each(e.oldGroups,function(i,j){if(j.id==e.id)if(c["filterGruppe "+f]!=null&&j.gp_id==c["filterGruppe "+f]||c["filterDistrikt "+f]!=null&&c["filterGruppe "+f]==null&&
masterData.groups[j.gp_id]!=null&&masterData.groups[j.gp_id].distrikt_id==c["filterDistrikt "+f]||c["filterGruppe "+f]==null&&c["filterDistrikt "+f]==null&&masterData.groups[j.gp_id]!=null&&masterData.groups[j.gp_id].gruppentyp_id==c["filterTyp "+f])if(c["filterGruppeWarInVon "+f]==null&&c["filterGruppeWarInBis "+f]==null){if(c["filterTeilnehmerstatus "+f]==null&&j.leiter==-99||j.leiter==c["filterTeilnehmerstatus "+f])h=true}else{if(arr2[j.gp_id]==null)arr2[j.gp_id]=[];arr2[j.gp_id].push(j)}});c["filterGruppeWarInBis "+
f]!=null&&$.each(arr2,function(i,j){i=churchcore_sortData(j,"d");var l="";$.each(i,function(m,n){if(c["filterTeilnehmerstatus "+f]==null&&n.leiter>=0||c["filterTeilnehmerstatus "+f]==n.leiter)l=n.d;else if(l!=""&&(n.leiter==-99||c["filterTeilnehmerstatus "+f]!=null)){if((c["filterGruppeWarInBis "+f]==null||l.toDateEn()<=c["filterGruppeWarInBis "+f].toDateDe())&&(c["filterGruppeWarInVon "+f]==null||n.d.toDateEn()>=c["filterGruppeWarInVon "+f].toDateDe()))h=true;l=""}})})}!h&&c["filterGruppeWarInBis "+
f]&&e.gruppe!=null&&$.each(e.gruppe,function(i,j){if(c["filterGruppe "+f]!=null)if(j.id==c["filterGruppe "+f])if(j.d.toDateEn()<=c["filterGruppeWarInBis "+f].toDateDe())if(c["filterTeilnehmerstatus "+f]==null||c["filterTeilnehmerstatus "+f]==j.leiter)h=true;if(c["filterDistrikt "+f]!=null&&masterData.groups[j.id]!=null)if(masterData.groups[j.id].distrikt_id==c["filterDistrikt "+f])if(j.d.toDateEn()<=c["filterGruppeWarInBis "+f].toDateDe())if(c["filterTeilnehmerstatus "+f]==null||c["filterTeilnehmerstatus "+
f]==j.leiter)h=true});if(!h)return false}return true}function checkKommentar(e,c){var f=false;e!=null&&$.each(e,function(g,h){if(h.comment!=null&&h.comment.toUpperCase().indexOf(c)!=-1)f=true});return f}
PersonView.prototype.checkFilter=function(e){var c=this.filter,f=this;if(e==null)return false;if(f.name=="PersonView"&&e.archiv_yn==1)return false;if(f.name=="ArchiveView"&&e.archiv_yn==0)return false;if(e.name==null)return true;if(masterData.settings.hideStatus!=null&&e.status_id!=null&&e.status_id==masterData.settings.hideStatus)return false;searchEntry=this.getFilter("searchEntry").toUpperCase();if(searchEntry!=""){var g=searchEntry.split(" "),h=true;$.each(g,function(n,o){if(o.indexOf("TAG:")==
0){if(!f.checkFilterTag(o,e.tags))return h=false}else if(o.indexOf("#")==0){if("#"+e.id!=o)return h=false}else if(o.indexOf("GRUPPE:")==0){if(e.gruppe==null)return h=false;var p=false;$.each(e.gruppe,function(q,s){if(masterData.groups[s.id].bezeichnung.toUpperCase().indexOf(o.substr(7,99).toUpperCase())>=0){p=true;return false}});p||(h=false);return false}else if(e.name.toUpperCase().indexOf(o)<0&&e.vorname.toUpperCase().indexOf(o)<0&&(e.email==null||e.email.toUpperCase().indexOf(o)!=0)&&e.spitzname.toUpperCase().indexOf(o)!=
0&&e.id!=o&&!checkKommentar(e.gruppe,o))return h=false});if(!h)return false}if(c.searchChecked!=null&&e.checked!=true)return false;if(this.getFilter("followupOverdue")!=""||c.followupToday!=null){if(e.gruppe==null)return false;var i=false;$.each(e.gruppe,function(n,o){if(_isFollowUpGroup(o)&&groupView.isPersonLeaderOfGroup(masterData.user_pid,o.id)){n=_getPersonGroupFollowupDiffDays(o);if(c.followupToday!=null&&n>=0&&n<14){i=true;return false}if(f.getFilter("followupOverdue")!=""&&n<0){i=true;return false}}});
if(!i)return false}if(c.groupDelete!=null||c.groupSubscribe!=null){if(e.gruppe==null)return false;i=false;$.each(e.gruppe,function(n,o){if((o.leiter==-1&&c.groupDelete!=null||o.leiter==-2&&c.groupSubscribe!=null)&&groupView.isPersonLeaderOfGroup(masterData.user_pid,o.id)){i=true;return false}});if(!i)return false}if(c["filterMeine Gruppen"]>0||c["filterMeine Gruppen"]<0){if(e.gruppe==null)return false;l=false;$.each(e.gruppe,function(n,o){if(o.id==c["filterMeine Gruppen"]&&o.leiter!=3){l=true;return false}});
if(!l)return false}if(this.filter.filterStatus!=null&&this.filter.filterStatus.filter(e.status_id))return false;if(this.filter.filterStation!=null&&this.filter.filterStation.filter(e.station_id))return false;if(c.filterBereich!=null){l=false;e.access!=null&&$.each(e.access,function(n,o){f.filter.filterBereich.filter(o)||(l=true)});if(!l)return false}if(c.withoutPicture!=null)if(e.imageurl!=null&&e.imageurl!="nobody.gif")return false;if(c.withoutEMail!=null)if(e.email!=null&&e.email!="")return false;
var j=1;g=true;if(c.filterOr!=null)g=false;for(;c["filterTyp "+j]!=null;){h=_checkGroupFilter(e,c,j);if(c.filterOr==null){if(!h)return false}else if(h)g=true;j+=1}if(!g)return false;if(e.searchable){if(c.filterAuth!=null)if(c.filterAuthNegativ==null){if(e.auth==null||!hasPersonAuth(e,c.filterAuth))return false}else if(e.auth!=null&&hasPersonAuth(e,c.filterAuth))return false;if(c.filterFamilienstatus!=null&&(e.familienstand_no==null||e.familienstand_no!=c.filterFamilienstatus))return false;if(c.filterGeschlecht!=
null&&(e.geschlecht_no==null||e.geschlecht_no!=c.filterGeschlecht))return false;if(c.plz!=null&&(e.plz==null||!e.plz.match("^"+c.plz)))return false;if(c.geburtsort!=null&&(e.geburtsort==null||e.geburtsort.indexOf(c.geburtsort)==-1))return false;if(c.filterNationalitaet!=null&&(e.nationalitaet_id==null||e.nationalitaet_id!=c.filterNationalitaet))return false;if(c.ageFrom!=null||c.ageTo!=null)if(e.geburtsdatum==null)return false;else{geb=new Date(e.geburtsdatum.substr(0,4),e.geburtsdatum.substr(5,2)-
1,e.geburtsdatum.substr(8,2));if(c.ageFrom!=null&&geb.getAgeInYears()<c.ageFrom)return false;if(c.ageTo!=null&&geb.getAgeInYears()>c.ageTo)return false}if(c.filterDates!=null&&c.dateBefore!=null&&c.dateBefore.toDateDe()!=null)if(e[c.filterDates]!=null){flt=e[c.filterDates].toDateEn();src=c.dateBefore.toDateDe();if(c.dateIgnoreYear!=null){flt.setFullYear(2E3);src.setFullYear(2E3)}console.log(flt);console.log(src);if(flt>src)return false}else return false;if(c.filterDates!=null&&c.dateAfter!=null&&
c.dateAfter.toDateDe()!=null)if(e[c.filterDates]!=null){flt=e[c.filterDates].toDateEn();src=c.dateAfter.toDateDe();if(c.dateIgnoreYear!=null){flt.setFullYear(2E3);src.setFullYear(2E3)}if(flt<src)return false}else return false;if(c.filterDates!=null&&c.dateNotSet!=null)if(e[c.filterDates]!=null)return false;if(c.filterRelations!=null)if(c.filterRelationNegativ==null){if(e.rels==null)return false;var l=false,m=c.filterRelations.substr(2,99);$.each(e.rels,function(n,o){if(o.beziehungstyp_id==m)if(masterData.relationType[m].bez_vater==
masterData.relationType[m].bez_kind)l=true;else if(c.filterRelations.substr(0,1)=="k"&&o.vater_id==e.id||c.filterRelations.substr(0,1)=="v"&&o.kind_id==e.id)l=true});if(!l)return false}else if(e.rels!=null){l=true;m=c.filterRelations.substr(2,99);$.each(e.rels,function(n,o){if(o.beziehungstyp_id==m)if(masterData.relationType[m].bez_vater==masterData.relationType[m].bez_kind)l=false;else if(c.filterRelations.substr(0,1)=="k"&&o.vater_id==e.id||c.filterRelations.substr(0,1)=="v"&&o.kind_id==e.id)l=
false});if(!l)return false}if(c.filterRelationExt!=null&&c.filterRelationExtGroupTyp!=null){l=false;if(e.rels!=null){m=c.filterRelationExt.substr(2,99);$.each(e.rels,function(n,o){if(o.beziehungstyp_id==m){n=null;if(masterData.relationType[m].bez_vater==masterData.relationType[m].bez_kind)n=o.vater_id==e.id?o.kind_id:o.vater_id;else if(c.filterRelationExt.substr(0,1)=="k"&&o.vater_id==e.id)n=o.kind_id;else if(c.filterRelationExt.substr(0,1)=="v"&&o.kind_id==e.id)n=o.vater_id;n!=null&&allPersons[n]!=
null&&allPersons[n].gruppe!=null&&$.each(allPersons[n].gruppe,function(p,q){if(c.filterRelationExtGroup!=null){if(c.filterRelationExtGroup==q.id)l=true}else if(c.filterRelationExtGroupTyp==masterData.groups[q.id].gruppentyp_id)l=true;if(l)return false})}if(l)return false})}return l}if(c.filterFollowUp!=null)if(e.gruppe==null&&c.filterFollowUp>0)return false;else if(e.gruppe!=null){i=c.filterFollowUp>0?false:true;$.each(e.gruppe,function(n,o){if(_isFollowUpGroup(o))if(c.filterFollowUp>0){n=_getPersonGroupFollowupDiffDays(o);
if(c.filterFollowUpStep==null||o.followup_count_no==c.filterFollowUpStep)if(c.filterFollowUp==1)i=true;else if(c.filterFollowUp==2&&n<0)i=true}else i=false});if(!i)return false}j=0;for(h=true;c["filterTags"+j]!=null&&h;){h=false;if(e.tags==null)return false;$.each(e.tags,function(n,o){if(o==c["filterTags"+j]){h=true;return false}});j+=1}if(!h)return false}return true};
function hasPersonAuth(e,c){if(e.auth!=null&&e.auth[c]!=null)return true;var f=false;if(e.gruppe!=null){$.each(e.gruppe,function(g,h){h.leiter>=0&&!f&&masterData.groups[h.id].auth!=null&&$.each(masterData.groups[h.id].auth,function(i,j){if(j==c){f=true;return false}})});if(f)return true}if(masterData.status[e.status_id].auth!=null){$.each(masterData.status[e.status_id].auth,function(g,h){if(h==c)f=true});if(f)return true}return false}
function _renderRelationList(e,c){var f="";if(c==null)c=false;allPersons[e].rels!=null&&$.each(churchcore_sortMasterData(masterData.relationType),function(g,h){$.each(allPersons[e].rels,function(i,j){if(j.beziehungstyp_id==h.id){if(j.kind_id==e){f+=masterData.relationType[j.beziehungstyp_id].bez_vater;if(allPersons[j.vater_id]!=null)f=f+': <a href="#" id="person_'+j.vater_id+'" '+(masterData.auth.viewalldata?'tooltip="'+j.vater_id+'">':">")+allPersons[j.vater_id].vorname+" "+allPersons[j.vater_id].name+
"</a>"}else{f+=masterData.relationType[j.beziehungstyp_id].bez_kind;if(allPersons[j.kind_id]!=null)f=f+': <a href="#" id="person_'+j.kind_id+'" '+(masterData.auth.viewalldata?'tooltip="'+j.kind_id+'">':">")+allPersons[j.kind_id].vorname+" "+allPersons[j.kind_id].name+"</a>"}if(masterData.auth.write&&c)f=f+'&nbsp;&nbsp;(<a href="#" id="del_rel_'+j.id+'">entfernen</a>)';f+="<br/>"}})});return f}
function _renderOldGroupEntry(e){var c='<tr class="oldgroupentry"><td><p>',f="Wurde ge&auml;ndert von "+e.user+" am "+e.d.toDateEn(true).toStringDe(true),g="color:black;";if(e.leiter==1||e.leiter==2)g="color:black;font-weight:bold;";else if(e.leiter==3)g="color:gray;";else if(e.leiter==-1)g="color:gray;text-decoration:line-through;";else if(e.leiter==-99)g="color:gray;text-decoration:line-through;";c=c+'<i><small> > <a href="#" title="'+f+'" style="'+g+'" id="grp_'+e.gp_id+'">'+masterData.groups[e.gp_id].bezeichnung+
"</a>";if(e.leiter>0)c=c+" ("+masterData.groupMemberTypes[e.leiter].bezeichnung+")";else if(e.leiter==-99)c+=" <b>gel&ouml;scht</b>";return c=c+"</small><i><td><i><small>"+e.d.toDateEn().toStringDe()+"</small></i><td><td>"}function _getOldGroupEntries(e,c,f){var g="";count=0;$.each(allPersons[e].oldGroups,function(h,i){if(!i.used&&masterData.groups[i.gp_id]!=null&&masterData.groups[i.gp_id].gruppentyp_id==c&&f(i))g+=_renderOldGroupEntry(i)});return g}
PersonView.prototype.getGroupEntries=function(e,c,f){var g=this,h=[],i=false,j=[];$.each(allPersons[e].gruppe,function(o,p){if(masterData.groups[p.id]!=null&&masterData.groups[p.id].gruppentyp_id==c&&f(p)&&(masterData.auth.editgroups&&masterData.groups[p.id].versteckt_yn==0||groupView.isAllowedToSee(p.id)||groupView.isPersonLeaderOfGroup(masterData.user_pid,p.id)||groupView.isGroupViewableForMembers(p.id)&&g.isPersonLeaderOfPerson(masterData.user_pid,e))){p.show=true;j.push(p)}});j.sort(function(o,
p){return o.d>p.d?-1:1});if(g.showGroupDetailsId!=c){var l=j.length,m=new Date;m.addDays(-1*masterData.groupnotchoosable);for(var n=j.length;n>0&&l>4;){n-=1;if(masterData.groups[j[n].id].abschlussdatum!=null&&masterData.groups[j[n].id].abschlussdatum.toDateEn()<m){j[n].show=false;l-=1;i=true}}for(n=j.length;n>0&&l>4;){n-=1;j[n].show=false;l-=1;i=true}}$.each(j,function(o,p){if(p.show){_text='<tr style="background:#F4F4F4;"><td><p>';o="Seit ";if(p.d!=null)o+=p.d.toDateEn().toStringDe();o=o+" von "+
p.user;var q="color:black;";if(p.leiter==1||p.leiter==2)q="color:black;font-weight:bold;";else if(p.leiter==3)q="color:gray;";else if(p.leiter==-2)q="color:#3a87ad;";else if(p.leiter==-1)q="color:red;text-decoration:line-through;";var s=masterData.groups[p.id].bezeichnung;if(p.leiter==-2)s+="?";_text=groupView.isAllowedToSee(p.id)?_text+'<small><a href="#" title="'+o+'" style="'+q+'" id="grp_'+p.id+'">'+s+"</a>":p.leiter==-1?_text+'<small style="text-decoration:line-through;">'+s:_text+"<small>"+
s;if(p.comment!=null&&(masterData.auth.editgroups||groupView.isPersonLeaderOfGroup(masterData.user_pid,p.id)))_text=_text+"&nbsp;"+g.renderImage("comment",16,"Kommentar: "+p.comment);if(masterData.auth.adminpersons&&masterData.groups[p.id].auth!=null)_text=_text+"&nbsp;"+g.renderImage("schluessel",16,"Berechtigungen: "+g.getAuthAsArray(masterData.groups[p.id].auth).join(", "));if(p.leiter>0)_text=_text+" ("+masterData.groupMemberTypes[p.leiter].bezeichnung+")";else if(masterData.groups[p.id].followup_typ_id>
0)_text=_text+' <i>(FollowUp: "'+masterData.followupTypes[masterData.groups[p.id].followup_typ_id].bezeichnung.trim(20)+")</i>";_text=_text+"</small><td><p><small>"+(p.d!=null?p.d.toDateEn().toStringDe():"")+"</small>";if(masterData.auth.editgroups||groupView.isPersonLeaderOfGroup(masterData.user_pid,p.id)){_text=_text+'<td style="padding:0;width:16px;"><a href="#" id="editPersonGroupRelation'+p.id+'" grouptype="'+a.id+'">'+g.renderImage("options",16)+"</a>";_text=_text+'<td style="padding:0;width:16px;"><a href="#" id="delPersonGroupRelation'+
p.id+'">'+g.renderImage("trashbox",16)+"</a>"}g.showGroupDetailsId==c&&g.showGroupDetailsWithHistory&&allPersons[e].oldGroups!=null&&$.each(allPersons[e].oldGroups,function(u,v){if(v.gp_id==p.id){v.used=true;_text+=_renderOldGroupEntry(v)}});h.push(_text)}});i&&h.push('<tr style="background:#F4F4F4;"><td><a href="#" id="f_gruppe_showmore_'+c+'">...</a><td><td><td>');return h.join("")};
function _isFollowUpGroup(e){return masterData.groups[e.id]!=null&&masterData.groups[e.id].followup_typ_id>0&&e.followup_count_no>0?true:false}function _getFollowupDiffDays(e,c){var f;$.each(masterData.followupTypIntervall,function(g,h){if(h.followup_typ_id==e&&h.count_no==c)f=h.days_diff*1});return f}function _getNextFollowupCountNo(e,c){var f=null;c++;$.each(masterData.followupTypIntervall,function(g,h){if(h.followup_typ_id==e&&h.count_no==c)f=h.count_no});return f}
function _getPersonGroupFollowupDiffDays(e){if(_isFollowUpGroup(e)){var c=e.d.toDateEn(),f=_getFollowupDiffDays(masterData.groups[e.id].followup_typ_id,e.followup_count_no);if(e.followup_add_diff_days!=null)f+=e.followup_add_diff_days*1;c.addDays(f);return Math.round((c-new Date)/864E5)+1}else return null}
PersonView.prototype.renderAuthDialog=function(e){var c=this,f="";f+="<h3>Anpassung der Berechtigungen</h3><br/>";if(a.active_yn==1){f=f+"<p>"+c.renderImage("schluessel")+'&nbsp;<a href="" title="Berechtigung editieren" id="personAuth">Berechtigungen anpassen</a><small> - Personen k&ouml;nen hier direkte Rechte zugewiesen werden</small>';f=f+"<p>"+c.renderImage("person_simulate")+'&nbsp;<a href="#" title="Person simulieren" id="simulatePerson">Person simulieren</a><small> - Berechtigung der Person testen</small>';
f=f+"<p>"+c.renderImage("netzwerk")+'&nbsp;<a href="#" title="Person per E-Mail einladen" id="invitatePerson">Person einladen</a><small> - Person erh&auml;lt per E-Mail einen Anmeldelink.</small>';f=f+"<p>"+c.renderImage("trashbox")+'&nbsp;<a href="#" title="Zugang sperren" id="deactivatePerson">Zugang sperren</a><small> - Berechtigungen entfernen und der Person den Zugang sperren.</small>';f=f+"<p>"+c.renderImage("attention")+'&nbsp;<a href="#" title="Passwort zur&uuml;cksetzen" id="setPassword">Passwort zur&uuml;cksetzen</a><small> - Der Person ein Passwort setzen.</small>'}else f=
f+"<p>"+c.renderImage("schluessel")+'&nbsp;<a href="" title="Zugang erlauben" id="activatePerson">Zugang erlauben</a><small> - Personen wieder den Zugang erlauben</small>';f+="<br/><br/><p><i><b>Hinweis: </b>";if(a.active_yn==0)f+="<font color=red>Zugang f&uuml;r Person gesperrt!</font>";else if(a.lastlogin!=null)f=f+"Person war zuletzt online am "+a.lastlogin.toDateEn(true).toStringDe(true);else f+=a.einladung==1?"Person ist bereits eingeladen":"Person wurde noch nie eingeladen";var g=c.showDialog("Anpassung der Berechtigungen",
f,500,380,{Schliessen:function(){$(this).dialog("close")}});g.find("a").click(function(){if($(this).attr("id")=="simulatePerson"){window.location.href="?q=simulate&id="+a.id+"&location=churchdb";return false}else if($(this).attr("id")=="invitatePerson"){if(a.email=="")alert("Ohne E-Mail-Adresse kann die Person nicht eingeladen werden!");else confirm("Wirklich "+a.vorname+" "+a.name+" einladen? Die Person bekommt eine E-Mail mit einem Link, wo sie dann das Passwort erstellen kann.")&&churchInterface.jsonWrite({func:"sendInvitationMail",
id:a.id},function(j){if(j){alert("Einladung wurde gesendet.");a.einladung=1;c.renderDetails(a.id)}else alert("Fehler: "+res)});return false}else if($(this).attr("id")=="personAuth"){c.editPersonAuth(e);return false}else if($(this).attr("id")=="deactivatePerson"){confirm("Wirklich "+a.vorname+" "+a.name+" den Zugang sperren? Der Zugang ist erst wieder nach einer neuen Einladung aktiv.")&&churchInterface.jsendWrite({func:"deactivatePerson",id:a.id},function(j,l){if(j){alert("Person wurde gesperrt.");
a.active_yn=0;a.auth=null;g.dialog("close");c.renderDetails(a.id)}else alert("Fehler: "+l)});return false}else if($(this).attr("id")=="activatePerson"){churchInterface.jsendWrite({func:"activatePerson",id:a.id},function(j,l){if(j){alert("Der Zugang ist wieder erlaubt. Sinnvoll kann es nun sein, eine Einladung zu senden.");a.active_yn=1;g.dialog("close");c.renderDetails(a.id)}else alert("Fehler: "+l)});return false}else if($(this).attr("id")=="setPassword"){var h=form_renderInput({label:"Neues Passwort",
type:"medium",password:true,cssid:"new_password"}),i=c.showDialog("Neues Passwort setzen",h,250,200,{Speichern:function(){churchInterface.jsendWrite({func:"setPersonPassword",id:a.id,password:$("#new_password").val()},function(j,l){if(j){alert("Das Passwort wurde gesetzt.");i.dialog("close")}else alert("Fehler: "+l)});$(this).dialog("close")},Abbruch:function(){$(this).dialog("close")}});return false}})};
PersonView.prototype.renderDetails=function(e){var c=this;if($("#detailTD"+e).length==0)return null;$("#detailTD"+e).html("Rendern...");a=allPersons[e];a.open=true;personLeader=false;allPersons[e].gruppe!=null&&masterData.user_pid!=null&&allPersons[masterData.user_pid].gruppe!=null&&$.each(allPersons[masterData.user_pid].gruppe,function(l,m){m.leiter>=1&&m.leiter<=2&&$.each(allPersons[e].gruppe,function(n,o){if(o.id==m.id&&masterData.groups[m.id]!=null){n=new Date;n.addDays(-masterData.groupnotchoosable);
if(masterData.groups[m.id].abschlussdatum==null||masterData.groups[m.id].abschlussdatum.toDateEn()>n)personLeader=true}})});var f=[];f.push('<div id="detail" class="detail-view-person">');var g="";if(masterData.auth.viewalldetails||personLeader)a.gruppe!=null&&$.each(a.gruppe,function(l,m){if(masterData.auth.viewalldata||groupView.isPersonLeaderOfGroup(masterData.user_pid,m.id)){l=_getPersonGroupFollowupDiffDays(m);if(l!=null){var n="",o="";if(l>0){o="background:lightgreen;border:solid 2px;border-color:white;";
n="Ist f&auml;llig in "+l+" Tagen"}else if(l==0){o="background:orange;border:solid 0px;border-color:gray;";n="<b>Ist heute f&auml;llig!</b>"}else{o="background:#FFAAAA;border:solid 2px;border-color:red;color:black;";n="<b>Ist f&auml;llig seit "+-l+" Tagen!</b>"}(new Date).addDays(l);g=g+'<div style="'+o+'padding:4px 8px 4px 8px">FollowUp <i>"'+masterData.followupTypes[masterData.groups[m.id].followup_typ_id].bezeichnung+" ("+m.followup_count_no+')"</i> von '+masterData.groups[m.id].bezeichnung+": "+
n;if(m.followup_add_diff_days!=null&&m.followup_add_diff_days!=0)g=g+"&nbsp; <small><i>(inklusive "+m.followup_add_diff_days+" Tage Verschiebung)</i></small>";if(groupView.isPersonLeaderOfGroup(masterData.user_pid,m.id))g=g+'<br/><div id="cdb_followup_'+m.id+"_"+e+'"><a href="#" id="f_followup_'+m.id+'"><b>jetzt durchf&uuml;hren</b></a></div>';g+="</div>"}}});g!=""&&f.push('<div class="row-fluid"><div class="span12">'+g+"</div></div>");f.push('<div class="row-fluid">');g='<div class="left-column-person span4">';
g=masterData.auth.write||personLeader?g+'<p><a id="f_image" href="">'+this.renderPersonImage(a.id)+"</a>":g+"<p>"+this.renderPersonImage(a.id);g+="<p style='line-height:100%;color:black'>";if(a.geburtsdatum!=null){geb=new Date(a.geburtsdatum.substr(0,4),a.geburtsdatum.substr(5,2)-1,a.geburtsdatum.substr(8,2));g=g+a.vorname+" "+a.name+" ("+geb.getAgeInYears()+") &nbsp; "}else g=g+a.vorname+" "+a.name+" &nbsp; ";if(a.email!="")g=g+'<a href="#" title="E-Mail an Person schreiben" id="mailPerson">'+c.renderImage("email")+
"</a>&nbsp;";if(a.telefonhandy!=""&&masterData.auth.sendsms)g=g+form_renderImage({src:"mobile.png",width:20,label:"SMS an Person schreiben",cssid:"smsPerson"})+"&nbsp;";if(masterData.auth.adminpersons&&a.active_yn==1)g=g+'<a href="#" title="Person simulieren" id="simulatePerson">'+c.renderImage("person_simulate")+"</a>&nbsp;";if(masterData.auth.viewalldetails||personLeader)g=g+'<small style="color:grey;"><br/>'+_renderRelationList(e)+"</small>";g+="<br/>";if(document.all?document.body.clientWidth:
window.innerWidth>800)g=g+'<div id="map_canvas'+e+'" class="map-canvas-person"></div>';else g+="<small><i>Zu wenig Platz f&uumlr die Karte, bitte Browserfenster vergr&ouml;ssern.</i></small>";g+="</div>";g+='<div id="detailAddress" class="span4 middle-column-person">';g+=masterData.auth.viewaddress||masterData.auth.viewalldetails||personLeader?c.renderFields(masterData.fields.f_address,a,masterData.auth.write||personLeader,["ViewAllDetailsOrPersonLeader"]):c.renderFields(masterData.fields.f_address,
a,masterData.auth.write||personLeader,null);if(masterData.auth.viewalldetails)g+=c.renderFields(masterData.fields.f_church,a,masterData.auth.write);else if(a.geburtsdatum!=null){g+="<p><b><i>Information</i></b><br/><small>Geburtstag: ";g=g+a.geburtsdatum.toDateEn().toStringDe()+"</small>"}if(masterData.auth.viewalldetails)g+=c.renderFields(masterData.fields.f_category,a,masterData.auth.write);else{g+="<p><b><i>Kategorie</i></b><br/><small>Mitglied: ";g+=masterData.status[a.status_id].mitglied_yn==
1?"ja":"nein";g+="</small>"}if(masterData.auth.adminpersons){g+="<h4>Berechtigungen&nbsp;&nbsp;";g=g+'<a href="#" id="auth">'+c.renderImage("options")+"</a></h4>";g+='<p style="line-height:100%;color:black"><small>';var h="";if(a.active_yn==0)g+="<font color=red>Zugang f&uuml;r Person gesperrt!</font>";else h=a.lastlogin!=null?"Zuletzt online am "+a.lastlogin.toDateEn(true).toStringDe(true):a.einladung==1?"Bereits eingeladen":"Nicht eingeladen";g=g+h+"</small><br/>";if(a.districts!=null){g+="<p><small><b>Zugeordnete Distrikte:</b>";
$.each(a.districts,function(l,m){g=g+"<br/>- "+masterData.districts[m.distrikt_id].bezeichnung+""});g+="</small>"}if(a.gruppentypen!=null){g+="<p><small><b>Zugeordnete Gruppentypen:</b>";$.each(a.gruppentypen,function(l,m){g=g+"<br/>- "+masterData.groupTypes[m.gruppentyp_id].bezeichnung+""});g+="</small>"}}g+="</div>";g+='<div class="right-column-person span4">';g+=c.renderTags(a.tags,masterData.auth.write||personLeader,e);if(masterData.auth.comment_viewer!=null){g+='<div class="detail-view-infobox"><table><tr><th>Kommentare';
var i="",j=0;a.comments!=null&&$.each(a.comments,function(l,m){j++;if(j<=3||c.showAllCommentDetails){l=m.relation_name=="person_followup"?"followup_comment":"";var n=m.text.replace(/(http:\/\/\S*)/g,'<a target="_clean" href="$1">$1</a>');n=n.replace(/(https:\/\/\S*)/g,'<a target="_clean" href="$1">$1</a>');i=i+'<tr><td class="'+l+'"><p><small>'+n;i+='<br/><font color="grey"><i>(';i=allPersons[m.person_id]!=null?i+'<a href="#" id="person_'+m.person_id+'" tooltip="'+m.person_id+'">'+allPersons[m.person_id].vorname+
" "+allPersons[m.person_id].name+"</a>":i+"["+m.person_id+"]";i=i+"/"+masterData.comment_viewer[m.comment_viewer_id].bezeichnung+" "+m.datum.toDateEn().toStringDe()+")</i></font></small>";i=i+'<td style="padding:0;width:16px;" class="'+l+'">';if(masterData.auth.write)i=i+'<a href="#" id="del_note'+m.id+'"><img width=16px src="'+masterData.modulespath+'/images/trashbox.png"/></a>'}});g+='<th style="width:32px;padding:0 4px 0 0;">';if(j>3)if(c.showAllCommentDetails)g=g+'<i><a href="#" id="f_comments_show"><img width="16px" src="'+
masterData.modulespath+'/images/closed.png" align="absmiddle"/></a></i>';else{g=g+'<i><a href="#" id="f_comments_show"><img width="16px" src="'+masterData.modulespath+'/images/opened.png" align="absmiddle"/></a></i>';i+='<tr style="background:#F4F4F4;"><td><a href="#" id="f_comments_show">...</a><td>'}if(masterData.auth.write||personLeader&&masterData.auth.comment_viewer!=null)g=g+'<a href="" id="f_note"><img width=16px src="'+masterData.modulespath+'/images/plus.png" align="absmiddle"/></a>';g+=
i;g+="</table></div><small><br/></small>"}f.push(g);allPersons[e]!=null&&$.each(churchcore_sortMasterData(masterData.groupTypes),function(l,m){if(masterData.auth.viewalldetails||m.anzeigen_in_meinegruppen_teilnehmer_yn==1||masterData.auth.editgroups||c.isPersonLeaderOfOneGroupTypeOfPerson(masterData.user_pid,m.id,e)){g="";g=g+'<div class="detail-view-infobox"><table><tbody style="border:none"><tr><th>'+m.bezeichnung;g+='<th class="datum"><th style="width:16px;padding:0">';g=c.showGroupDetailsId!=
m.id?g+'<a href="#" id="f_gruppe_show_'+m.id+'"><img width="16px" src="'+masterData.modulespath+'/images/opened.png" align="absmiddle"/></a>':g+'<a href="#" id="f_gruppe_show_'+m.id+'"><img width="16px" src="'+masterData.modulespath+'/images/closed.png" align="absmiddle"/></a>';g+='<th style="width:16px;padding:0 4px 0 0">';l="";if(masterData.auth.editgroups||c.getAvailableAddGroupsForGrouptype(m.id)!=null){g=g+'<a href="#" id="addPersonGroupRelation'+m.id+'"><img width=16px src="'+masterData.modulespath+
'/images/plus.png" align="absmiddle"/></a>';l=" "}allPersons[e].oldGroups!=null&&c.showGroupDetailsId==m.id&&c.showGroupDetailsWithHistory&&$.each(allPersons[e].oldGroups,function(n,o){o.used=false});if(allPersons[e].gruppe!=null){l+=c.getGroupEntries(e,m.id,function(n){return n.leiter>0});l+=c.getGroupEntries(e,m.id,function(n){return n.leiter==0});l+=c.getGroupEntries(e,m.id,function(n){return n.leiter<0})}if(allPersons[e].oldGroups!=null&&c.showGroupDetailsId==m.id&&c.showGroupDetailsWithHistory)l+=
_getOldGroupEntries(e,m.id,function(){return true});l!=""&&f.push(g+l+"</table></div>")}});f.push("</div>");g='<div style="clear:both">';g+='<div class="detail-footer">';g+='<div class="bottom_links" style="display:inline;"> &nbsp; ';if(masterData.auth.viewhistory)g+='<a href="#" id="logs">Historie >></a>&nbsp; &nbsp; ';if(masterData.auth.editrelations)g+=' <a href="#" id="rels">Beziehungen pflegen >></a>&nbsp; &nbsp;';g+='<a href="#" id="vcard">VCard export>></a></div><!--bottom_links--\>';g+='<div style="float:right">';
g+="<small><i>Bereiche: </i>";$.each(masterData.auth.dep,function(l,m){if(allPersons[e].access!=null&&allPersons[e].access[m.id]==m.id)g=g+" "+m.bezeichnung+"&nbsp;"});if(masterData.auth.write)g=g+'<a href="#" id="f_bereich"><img width="16px" align="absmiddle" src="'+masterData.modulespath+'/images/options.png"/></a> &nbsp; &nbsp; &nbsp;';if(masterData.auth.admin||masterData.auth.adminpersons){g+="&nbsp;Admin-Funktion: ";if(masterData.auth.viewarchive&&a.archiv_yn==0)g=g+'&nbsp;<a href="#" title="Person archivieren" id="archivePerson">'+
form_renderImage({src:"archive.png",width:18})+"</a>";if(masterData.auth.viewarchive&&a.archiv_yn==1)g=g+'&nbsp;<a href="#" title="Person zur&uuml;ckeholen" id="undoArchivePerson">'+form_renderImage({src:"undoarchive.png",width:18})+"</a>";g=g+'&nbsp;<a href="#" title="Person entfernen" id="delete_user">'+form_renderImage({src:"trashbox.png",width:18})+"</a>&nbsp;&nbsp;"}g=g+'&nbsp;<a href="#" id="person_'+a.id+'">#'+a.id+"</a></i></small>&nbsp;&nbsp;";g+="</div><!--float-right--\>";g+="</div><!--detail-footer--\>";
g=g+'<div id="detail_logs'+e+'" class="logs"></div>';g=g+'<div id="detail_rels'+e+'" class="relations">';g+="<p style='line-height:100%;' id=\"pRels\"><b><i>Beziehungen</i></b>&nbsp;&nbsp;";g+="<p style='line-height:100%;color:black'><small>";g+=_renderRelationList(e,true);if(masterData.auth.editrelations){g+="<br/>";$.each(masterData.relationType,function(l,m){g=g+'<i><a href="#" id="f_rels_k_'+m.id+'">'+m.bez_kind+" hinzuf&uuml;gen</a></i> &nbsp; &nbsp;";if(m.bez_kind!=m.bez_vater)g=g+'<i><a href="#" id="f_rels_v_'+
m.id+'">'+m.bez_vater+" hinzuf&uuml;gen</a></i> &nbsp; &nbsp;"})}g+="<br/></small>";g+="</div>";g+="</div>";g+="</div>";f.push(g);$("#detailTD"+e).html(f.join(""));if(a.plz!=""||a.ort!="")cdb_showGeoPerson(a.strasse+", "+a.plz+" "+a.ort,e,!(personLeader||masterData.auth.viewalldata));c.addTagCallbacks(e,function(l){if(allPersons[e].tags==null)allPersons[e].tags=[];allPersons[e].tags.push(l);churchInterface.jsonWrite({func:"addPersonTag",id:e,tag_id:l});c.renderList(allPersons[e])});$("td[id=detailTD"+
e+"] a").click(function(){c.clearTooltip(true);var l=$(this).parents("td").attr("id")!=null&&$(this).parents("td").attr("id")!=""?$(this).parents("td").attr("id").substring(8,100):$(this).parents("td").parents("td").attr("id").substring(8,100),m=$(this).attr("id");if(m=="logs")if($("#detail_logs"+l).is(":hidden")){$("#detail_logs"+l).html("Lade Daten...");$("#detail_logs"+l).animate({height:"toggle"},"medium");jQuery.getJSON("index.php?q=churchdb/ajax",{func:"getPersonDetailsLogs",id:l},function(q){g=
"";g+='<small><table class="table"><tr><td><i>Datum</i><td><i>Text</i><td><i>Erfolgt durch</i><td>';q!=null&&$.each(q,function(s,u){if(u.level<3||masterData.auth.admin){color="gray";if(u.level==1)color="red";else if(u.level==2)color="black";g=g+'<tr style="line-height:100%;color:'+color+'"><td><nobr>'+u.datum.toDateEn().toStringDe(true)+"</nobr><td>"+u.txt+"<td>";g=allPersons[u.person_id]!=null?g+"<nobr>"+allPersons[u.person_id].vorname+" "+allPersons[u.person_id].name+" ["+u.person_id+"]</nobr>":
g+"["+u.person_id+"]"}});g+="</table></small>";$("#detail_logs"+l).html(g)})}else $("#detail_logs"+l).animate({height:"toggle"},"fast");else if(m=="rels")$("#detail_rels"+l).animate({height:"toggle"},"fast");else if(m=="vcard"){fenster=window.open("?q=churchdb/vcard&id="+l,"fenster1","width=600,height=400,status=yes,scrollbars=yes,resizable=yes");fenster.focus()}else if(m=="extern"||m=="")return true;else if(m=="auth")c.renderAuthDialog(l);else if(m=="simulatePerson"){if(masterData.settings.hideSimulateQuestion==
"1"||confirm("Wirklich "+a.vorname+" "+a.name+" simulieren? Simulation kann durch das Benutzer-Menu beendet werden.")){masterData.settings.hideSimulateQuestion==null&&churchInterface.jsonWriteSyncron({func:"saveSetting",sub:"hideSimulateQuestion",val:"1"});window.location.href="?q=simulate&id="+allPersons[l].id+"&location=churchdb"}}else if(m.indexOf("grp_")==0){$("tr[id=groupinfos"+l+"]").text()!=""&&$("tr[id=groupinfos"+l+"]").remove();churchInterface.setCurrentView(groupView);groupView.clearFilter();
groupView.setFilter("searchEntry",m.substring(4,99));groupView.renderView()}else if(m.indexOf("person_")==0){c.clearFilter();c.setFilter("searchEntry","#"+$(this).attr("id").substr(7,99));c.renderFurtherFilter();c.renderListMenu();c.renderList()}else if(m.indexOf("del_rel_")==0){if(confirm("Beziehung wirklich entfernen?")){rel_id=$(this).attr("id").substr(8,99);churchInterface.jsonWrite({func:"del_rel",id:l,rel_id:rel_id},function(){$("tr[id=detail"+l+"]").html("");cdb_loadRelations(function(){c.renderEntryDetail(l)})})}}else if($(this).attr("id").indexOf("detail_close")==
0){$("#detailTD"+l).remove();return false}else if(m.indexOf("f_gruppe_show_")==0){if(c.showGroupDetailsId==m.substr(14,99)){c.showGroupDetailsId=null;c.showGroupDetailsWithHistory=false}else{c.showGroupDetailsId=m.substr(14,99);c.showGroupDetailsWithHistory=true}c.renderDetails(l)}else if(m.indexOf("f_gruppe_showmore_")==0){c.showGroupDetailsId=m.substr(18,99);c.renderDetails(l)}else if(m=="f_comments_show"){c.showAllCommentDetails=!c.showAllCommentDetails;c.renderDetails(l)}else if(m.indexOf("f_rels_")==
0){renderDivid=false;c.renderPersonSelect("Auswahl f&uuml;r: "+$(this).attr("text"),false,function(q){if(q!=null){$("#cbn_editor").html("<p><br/><b>Daten werden gespeichert...</b><br/><br/>");obj={};obj.func="add_rel";if(m.substr(7,1)=="k"){obj.id=l;obj.child_id=q}else{obj.id=q;obj.child_id=l}obj.rel_id=m.substr(9,99);churchInterface.jsonWrite(obj,function(){$("tr[id=detail"+l+"]").html("");cdb_loadRelations(function(){c.renderEntryDetail(l)})})}})}else if(m.indexOf("f_followup_")==0){p=m.substring(11,
99);var n=[];b=allPersons[l].gruppe[p];b.comment!=null&&n.push("<p>Gruppenkommentar: </i>"+b.comment+"</p>");n.push('<div class="row-fluid"><div class="span5">');n.push(form_renderCheckbox({cssid:"followupOk_"+p+"_"+l,label:"FollowUp erfolgreich"}));n.push('<textarea class="input-xlarge" rows="4" id="followupNote_'+p+"_"+l+'"/><br/>');n.push('</div> <div class="span5 well">');var o=_getFollowupTypIntervall(masterData.groups[b.id].followup_typ_id,b.followup_count_no);n.push("<i>"+masterData.followupTypes[masterData.groups[b.id].followup_typ_id].bezeichnung+
" Stufe "+b.followup_count_no+"</i><br/>"+o.info+"<br/>");n.push("</div></div>");n.push('<div id="cdbfollowupDiff_'+p+"_"+l+'">Erinnern in <input type="text" class="input-mini" size="2" maxlength="2" id="followupDiff_'+p+"_"+l+'" value="2"></input> Tagen<br/></div>');n.push('<div id="cdbfollowupNachfolger_'+p+"_"+l+'" style="display:none">');if(_getFollowupTypIntervall(masterData.groups[b.id].followup_typ_id,b.followup_count_no*1+1)==null)if(masterData.groups[b.id].fu_nachfolge_typ_id==0)n.push("<p><small><i>Hinweis: Dieses FollowUp wird dann beendet.</i></small>");
else{n.push("<p>Hinweis: Dieses FollowUp wird dann beendet ");if(masterData.groups[b.id].fu_nachfolge_gruppenteilnehmerstatus_id==null)masterData.groups[b.id].fu_nachfolge_gruppenteilnehmerstatus_id=0;if(masterData.groups[b.id].fu_nachfolge_typ_id==3){if(masterData.groups[b.id].fu_nachfolge_objekt_id!=null){n.push("und die Person wird in die Gruppe <i>"+masterData.groups[masterData.groups[b.id].fu_nachfolge_objekt_id].bezeichnung+"</i>");n.push(" als <i>"+masterData.groupMemberTypes[masterData.groups[b.id].fu_nachfolge_gruppenteilnehmerstatus_id].bezeichnung+
"</i>");n.push(" hinzugef&uuml;gt");n.push('<input type="hidden" id="selectNachfolgegruppe_'+p+"_"+l+'" value="'+masterData.groups[b.id].fu_nachfolge_objekt_id+'"></input>')}}else if(masterData.groups[b.id].fu_nachfolge_typ_id>0){n.push("und die Person kann nun in eine Gruppe ");n.push(" als <i>"+masterData.groupMemberTypes[masterData.groups[b.id].fu_nachfolge_gruppenteilnehmerstatus_id].bezeichnung+"</i>");n.push(" &uuml;bernommen werden.<br/>Gruppe: ");n.push('<select id="selectNachfolgegruppe_'+
p+"_"+l+'"');n.push('<option value="-1">-</option>');$.each(masterData.groups,function(q,s){if((masterData.groups[b.id].fu_nachfolge_typ_id==1&&s.gruppentyp_id==masterData.groups[b.id].fu_nachfolge_objekt_id||masterData.groups[b.id].fu_nachfolge_typ_id==2&&s.distrikt_id==masterData.groups[b.id].fu_nachfolge_objekt_id)&&s.valid_yn==1&&s.versteckt_yn==0)n.push("<option value="+s.id+">"+s.bezeichnung+"</option>")});n.push("</select>")}}else n.push("<p><small><i>Hinweis: Das FollowUp geht dann in die Stufe "+
(b.followup_count_no*1+1)+"</i></small>");n.push("</div>");n[n.length]='<p><input type="button" class="btn btn-royal" id="idFollowupSave_'+p+"_"+l+'" value="Speichern"/>&nbsp;';n[n.length]='<input type="button" class="btn btn-alert" id="idFollowupAbort_'+p+"_"+l+'" value="FollowUp abbrechen"/>&nbsp;&nbsp;';n[n.length]='<a href="#" id="idFollowupCancel_'+p+"_"+l+'">Sp&auml;ter durchf&uuml;hren</a>';n.push("</div>");$("#cdb_followup_"+p+"_"+l).html(n.join(""));$("#followupOk_"+p+"_"+l).change(function(){$("#cdbfollowupDiff_"+
p+"_"+l).toggle(!$(this).attr("checked"));$("#cdbfollowupNachfolger_"+p+"_"+l).toggle($(this).attr("checked"))});$("#idFollowupCancel_"+p+"_"+l).click(function(){c.renderDetails(l);return false});$("#idFollowupAbort_"+p+"_"+l).click(function(){var q="",s=null;if(allPersons[l].gruppe[p].followup_erfolglos_zurueck_gruppen_id!=null&&masterData.groups[allPersons[l].gruppe[p].followup_erfolglos_zurueck_gruppen_id]){s=allPersons[l].gruppe[p].followup_erfolglos_zurueck_gruppen_id;q="Das FollowUp bei "+a.vorname+
" "+a.name+" wirklich abbrechen? Das FollowUp geht zurueck an Gruppe '"+masterData.groups[s].bezeichnung+"'!"}else q="Das FollowUp bei "+a.vorname+" "+a.name+" wirklich abbrechen? Achtung, um das FollowUp wieder zu starten, muss die Person wieder der entsprechend Gruppen zugeordnet werden!";if(confirm(q)){churchInterface.jsonWrite({func:"delPersonGroupRelation",id:l,g_id:p});delete allPersons[l].gruppe[p];q={};q.note='Followup "'+masterData.followupTypes[masterData.groups[p].followup_typ_id].bezeichnung+
'" wurde abgebrochen. ';q.note=q.note+"<br/>"+$("#followupNote_"+p+"_"+l).val();q.func="f_note";q.relation_name="person_followup";q.id=l;q.comment_viewer=masterData.followupTypes[masterData.groups[p].followup_typ_id].comment_viewer_id;if(s!=null){c.addPersonGroupRelation(l,s);q.note=q.note+" Es geht zur&uuml;ck an "+masterData.groups[s].bezeichnung}churchInterface.jsonWriteSyncron(q);allPersons[l].details=null;c.renderList();c.renderTodos();return false}});$("#idFollowupSave_"+p+"_"+l).click(function(){var q=
{};q.note='Followup "'+masterData.followupTypes[masterData.groups[p].followup_typ_id].bezeichnung+'"';q.func="f_note";q.relation_name="person_followup";q.id=l;q.comment_viewer=masterData.followupTypes[masterData.groups[p].followup_typ_id].comment_viewer_id;var s=_getPersonGroupFollowupDiffDays(b)*-1;if(s<0)s=0;b.followup_add_diff_days=b.followup_add_diff_days==null?s:b.followup_add_diff_days*1+s;if($("#followupOk_"+p+"_"+l).attr("checked")){b.followup_count_no=_getNextFollowupCountNo(masterData.groups[p].followup_typ_id,
b.followup_count_no);if(b.followup_count_no!=null){q.followup_gid=p;q.followup_count_no=b.followup_count_no;q.followup_add_diff_days=b.followup_add_diff_days;q.note=q.note+" erfolgreich, nun Step "+b.followup_count_no;if(s>0||b.followup_add_diff_days>0)q.note=q.note+" mit insg. "+b.followup_add_diff_days+" Tagen Differenz (+"+s+")"}else{churchInterface.jsonWrite({func:"delPersonGroupRelation",id:l,g_id:p});delete allPersons[l].gruppe[p];q.note=q.note+" abgeschlossen mit "+b.followup_add_diff_days+
" Tagen Differenz, Gruppe "+masterData.groups[p].bezeichnung+" wird entfernt.";s=$("#selectNachfolgegruppe_"+p+"_"+l).val();if(s!=null){alert("Nachfolgegruppe "+masterData.groups[s].bezeichnung+" wurde bei der Person eingetragen");c.addPersonGroupRelation(l,s,masterData.groups[p].fu_nachfolge_gruppenteilnehmerstatus_id,p)}}}else{q.note+=" erfolglos. ";if($("#followupDiff_"+p+"_"+l).attr("value")!=null){q.followup_gid=p;b.followup_add_diff_days=b.followup_add_diff_days*1+$("#followupDiff_"+p+"_"+l).attr("value")*
1;q.followup_add_diff_days=b.followup_add_diff_days;q.followup_count_no=b.followup_count_no;q.note=q.note+"Neuer Aufschub: "+$("#followupDiff_"+p+"_"+l).attr("value")+" Tage, insg.: "+b.followup_add_diff_days}}allPersons[l].details=null;q.note=q.note+"<br/>"+$("#followupNote_"+p+"_"+l).val();$("#cdb_followup_"+p+"_"+l).html("Speichern...");churchInterface.jsonWrite(q,function(){c.renderView();c.renderTodos()})})}else if(m.indexOf("delPersonGroupRelation")==0){var p=m.substring(22,99);c.delPersonFromGroup(l,
p)}else c.renderEditEntry(l,m);return false});$("#cdb_content a[tooltip]").mouseover(function(){c.prepareTooltip($(this))});$("#cdb_content a[tooltip]").mouseout(function(){c.clearTooltip()})};function _getFollowupTypIntervall(e,c){var f=null;$.each(masterData.followupTypIntervall,function(g,h){if(h.followup_typ_id==e&&h.count_no==c){f=h;return false}});return f}a=PersonView.prototype;
a.getAvailableAddGroupsForGrouptype=function(e){var c=null;$.each(masterData.groups,function(f,g){if(g.gruppentyp_id==e)if(groupView.isPersonLeaderOfGroup(masterData.user_pid,g.id)){if(c==null)c=[];c.push(g)}});return c};a.editPersonAuth=function(e){var c=this;this.editDomainAuth(e,allPersons[e].auth,"person",function(f){churchInterface.jsonRead({func:"getPersonDetails",id:f},function(g){allPersons[g.id]=cdb_mapJsonDetails(g,allPersons[g.id]);c.renderFilter();c.renderList()})})};
a.delPersonFromGroup=function(e,c,f){var g=this,h=allPersons[e];if(f==null)f=false;if(masterData.groupTypes[masterData.groups[c].gruppentyp_id].muss_leiter_enthalten_yn==1&&allPersons[e].gruppe[c].leiter==1){var i=false;$.each(allPersons,function(j,l){l.id!=e&&l.gruppe!=null&&$.each(l.gruppe,function(m,n){if(n.id==c&&n.leiter==1)i=true})});if(!i){alert("Bei "+h.vorname+" "+h.name+" nicht machbar, da es sich um den einzigen Leiter dieser Gruppe handelt. Gruppen des Gruppentyps '"+masterData.groupTypes[masterData.groups[c].gruppentyp_id].bezeichnung+
"' muessen mindestens einen Leiter haben.");return false}}if(masterData.auth.editgroups||groupView.isPersonSuperLeaderOfGroup(masterData.user_pid,c)){if(f||confirm(h.vorname+" "+h.name+" wirklich aus der Gruppe herausnehmen?"))churchInterface.jsonWrite({func:"delPersonGroupRelation",id:e,g_id:c},function(){$("tr[id=detail"+e+"]").remove();delete h.gruppe[c];if(churchInterface.getCurrentView().name=="PersonView"){g.renderList(h);g.renderTodos()}else churchInterface.getCurrentView().renderList()})}else{f=
new CC_Form("Person in der Gruppe als zu l&ouml;schen markieren");f.addCaption({label:"Person",text:h.vorname+" "+h.name});f.addCaption({label:"Gruppe",text:masterData.groups[c].bezeichnung});f.addTextarea({label:"Kommentar angeben",rows:4,cssid:"comment",placeholder:"Warum soll die Person nicht mehr in der Gruppe sein?",data:h.gruppe[c].comment!=null?h.gruppe[c].comment:""});g.showDialog("Person aus der Gruppe nehmen",f.render(false,"horizontal"),500,350,{Speichern:function(){var j=new Date,l=$("#comment").val();
churchInterface.jsonWrite({func:"editPersonGroupRelation",id:e,g_id:c,comment:$("#comment").val(),date:j.toStringEn(),leader:-1},function(){h.gruppe[c].leiter=-1;h.gruppe[c].comment=l;g.renderList(h)});$(this).dialog("close")},Abbruch:function(){$(this).dialog("close")}})}};
a.renderEntryDetail=function(e,c){var f=this;if(c==null)c=e;$("tr[id=detail"+e+"]").remove();$("tr[id="+e+"]").after('<tr id="detail'+c+'"><td colspan="10" id="detailTD'+c+'">Lade Daten..</td></tr>');if(allPersons[c]!=null&&allPersons[c].details==null)churchInterface.jsonRead({func:"getPersonDetails",id:c},function(g){if(g=="no access"){delete allPersons[c];f.clearFilter();f.renderView();alert("Leider fehlt die Berechtigung, um die Detaildaten dieser Person zu sehen.")}else{allPersons[g.id]=cdb_mapJsonDetails(g,
allPersons[g.id]);f.renderDetails(c)}});else allPersons[c]!=null&&f.renderDetails(c)};
a.renderEditEntry=function(e,c,f){var g=this,h=allPersons[e],i=[],j=550,l=650;buttonText="Speichern";if(masterData.fields[c]!=null){masterData.auth.viewalldetails||g.isPersonLeaderOfPerson(masterData.user_pid,e)?i.push(this.getStandardFieldsAsSelect(c,h,["ViewAllDetailsOrPersonLeader"])):i.push(this.getStandardFieldsAsSelect(c,h,[]));if(c=="f_category")l=300}else if(c=="f_note"){l=j=350;i[i.length]='<textarea cols="30" rows="4" id="InputNote"/><br/><br/>';i[i.length]="Der Kommentar soll zu sehen sein f&uuml;r:<br/> ";
i[i.length]='<select id="InputComment">';$.each(masterData.auth.comment_viewer,function(p,q){i[i.length]='<option value="'+q+'" '+(q==0?"selected":"")+">"+masterData.comment_viewer[q].bezeichnung+"</option>"});i[i.length]="</select><br/>"}else if(c.indexOf("addPersonGroupRelation")==0){if(masterData.groups==null){alert('Noch keine Gruppe vorhanden. Bitte erst eine Gruppe in der "Gruppenliste" anlegen!');return null}else{j=380;l=330;var m=c.substring(22,99);i.push("<table><tr><td><b>"+masterData.groupTypes[m].bezeichnung+
"</b>&nbsp;<td>");i.push('<select id="InputGroupEntry">');var n=new Date;n.addDays(-1*masterData.groupnotchoosable);$.each(churchcore_sortData(masterData.groups,"bezeichnung"),function(p,q){if(q.gruppentyp_id==m&&q.valid_yn==1&&(q.abschlussdatum==null||q.abschlussdatum.toDateEn()>n))if(groupView.isAllowedToSee(q.id)||masterData.auth.editgroups&&q.versteckt_yn==0){var s=false;allPersons[e].gruppe!=null&&$.each(allPersons[e].gruppe,function(u){if(q.id==u)s=true});if(!s){i.push("<option ");f==q.id&&
i.push("selected ");i.push('value="'+q.id+'">'+q.bezeichnung+"</option>")}}});if(masterData.auth.admingroups){i.push('<option value="">--</option>');i.push('<option value="create'+m+'">'+masterData.groupTypes[m].bezeichnung+" erstellen</option>")}}i.push("</select>");i.push("<tr><td>Teilnehmerstatus<td>");i.push('<select id="InputGroupLeader">');$.each(masterData.groupMemberTypes,function(p,q){i.push('<option value="'+p+'">'+q.bezeichnung+"</option>")});i.push("</select>");i.push("<tr><td>Dabei seit<td>");
h=new Date;i.push('<input type="text" id="InputDate" size="10" value="'+h.toStringDe()+'"/>');i.push("<tr><td>Notiz<td>");h=new Date;i.push('<textarea id="InputComment" size="10" rows="3"/></textarea>');i.push("</table>");c="addPersonGroupRelation"}else if(c.indexOf("editPersonGroupRelation")==0){j=380;l=330;h=c.substring(23,99);h=g.renderPersonGroupRelation(e,h);if(h==null)return false;i.push(h);c="editPersonGroupRelation"}else if(c=="f_bereich"){j=350;l=300;i.push("<h3>Anpassung der Bereiche</h3><p><small>Eine Person muss in mindestens einem Bereich sein</small>");
$.each(masterData.auth.dep,function(p,q){i[i.length]=allPersons[e].access[q.id]==q.id?'<p><input type="checkbox" id="InputBereich'+q.id+'"/ checked="true"/>':'<p><input type="checkbox" id="InputBereich'+q.id+'"/>';i[i.length]=" "+q.bezeichnung+""})}else if(c=="f_image"){l=j=300;i[i.length]='<p><div id="upload_button">Nochmal bitte...</div><p><div id="image_uploaded"/>'}else if(c.indexOf("del_note")==0){l=j=300;i[i.length]="Soll der Kommentar wirklich entfernt werden?";buttonText="Entfernen"}else if(c.indexOf("delete_user")==
0){l=j=300;i[i.length]="Soll die Person wirklich gel&ouml;scht werden? Achtung, dieses L&ouml;schen ist endg&uuml;ltig und entfernt auch alle Gruppenbeziehungen etc.!"}else if(c.indexOf("archivePerson")==0){l=j=300;i[i.length]="Die Person wird in das Archiv genommen und ist nur noch mit Archiv-Rechten sichtbar. Wirklich ausf&uuml;hren"}else if(c.indexOf("undoArchivePerson")==0){l=j=300;i[i.length]="Soll die Person wird wieder zur&uuml;ck in die normale Liste genommen werden?"}else if(c.indexOf("search_tag")==
0){this.setFilter("searchEntry","tag:"+masterData.tags[c.substring(10,99)].bezeichnung);allPersons[e].open=false;this.renderView();return false}else if(c.indexOf("del_tag")==0){allPersons[e].tags.splice($.inArray(c.substring(7,99),allPersons[e].tags),1);churchInterface.jsonWriteSyncron({func:"delPersonTag",id:e,tag_id:c.substring(7,99)});this.renderList();return false}else if(c.indexOf("add_tag")==0){$("#add_tag_field"+e).toggle();$("#input_tag"+e).focus();return false}else if(c.indexOf("mailPerson")==
0){g.mailPerson(e,allPersons[e].vorname+" "+allPersons[e].name);return false}else if(c.indexOf("smsPerson")==0){g.smsPerson([e]);return false}else alert("Sorry, "+c+" ist noch nicht fertig.");i[i.length]='<input type="hidden" id="fields" value="'+c+'"/><br/>';var o=this.showDialog("Ver&auml;nderung des Datensatzes",i.join(""),j,l,{Speichern:function(){g._saveEditEntryData(e,c,false,$(this))},Abbruch:function(){$(this).dialog("close")}});allPersons[e].inEdit=o;c=="f_image"&&new qq.FileUploader({element:document.getElementById("upload_button"),
action:"?q=churchdb/uploadImage",params:{userid:e},multiple:false,debug:true,onComplete:function(p,q,s){$("#image_uploaded").html('<img src="'+masterData.files_url+"/fotos/"+s.filename+'"/><input type="hidden" id="uploadfilename" name="filename" value="'+s.filename+'"/>')}});$("#InputGroupEntry,#InputGroupLeader").change(function(){var p=$("#InputGroupEntry").val();if(isNumber(p)){var q=groupView.getStatsOfGroup(p);if(masterData.groups[p].max_teilnehmer!=null&&masterData.groups[p].max_teilnehmer<=
q.count_all_member)if($("#InputGroupLeader").val()==0){alert("Gruppe "+masterData.groups[p].bezeichnung+" hat schon die maximale Anzahl von "+masterData.groups[p].max_teilnehmer+" Teilnehmern erreicht. Bitte andere Gruppe nehmen.");$("#InputGroupEntry").val("")}}else if(p!=""&&p.indexOf("create")==0){var s=p.substr(6,99),u=new CC_Form(masterData.groupTypes[s].bezeichnung+" erstellen");u.addInput({label:"Name der Gruppe",cssid:"name"});u.addHidden({cssid:"Inputf_grouptype",value:s});u.addSelect({label:"Distrikt",
data:masterData.districts,cssid:"Inputf_district"});o.dialog("close");form_showDialog("Gruppe erstellen",u.render(null,"vertical"),300,350,{Speichern:function(){var v=u.getAllValsAsObject();v.func="createGroup";$.getJSON("index.php?q=churchdb/ajax",v,function(w){w.result=="exist"?alert("Gruppe mit dem Namen existiert schon!"):cdb_loadMasterData(function(){g.renderEditEntry(e,c+s,w.id)})});g.renderList();$(this).dialog("close")},Abbruch:function(){$(this).dialog("close")}})}})};
a.renderPersonGroupRelation=function(e,c){var f=[];if(masterData.groupTypes[masterData.groups[c].gruppentyp_id].muss_leiter_enthalten_yn==1&&allPersons[e].gruppe[c].leiter==1){var g=false;$.each(allPersons,function(h,i){i.id!=e&&i.gruppe!=null&&$.each(i.gruppe,function(j,l){if(l.id==c&&l.leiter==1)g=true})});if(!g){alert("Nicht editierbar, da es sich um den einzigen Leiter der Gruppe handelt. Gruppen des Gruppentyps '"+masterData.groupTypes[masterData.groups[c].gruppentyp_id].bezeichnung+"' muessen mindestens einen Leiter haben.");
return null}}f.push("<table><tr><td><b>"+masterData.groupTypes[masterData.groups[c].gruppentyp_id].bezeichnung+"</b><td>");f.push(masterData.groups[c].bezeichnung);f.push('<input type="hidden" id="InputGroupEntry" value="'+c+'"/>');f.push("<tr><td>Teilnehmerstatus &nbsp; <td>");f.push('<select id="InputGroupLeader">');$.each(masterData.groupMemberTypes,function(h,i){f.push('<option value="'+h+'"'+(h==allPersons[e].gruppe[c].leiter?"selected":"")+">"+i.bezeichnung+"</option>")});f.push("</select>");
f.push("<tr><td>Dabei seit<td>");f.push('<input type="text" id="InputDate" size="10" value="'+allPersons[e].gruppe[c].d.toDateEn().toStringDe()+'"/>');f.push("<tr><td>Notiz<td>");f.push('<textarea id="InputComment" size="10" rows="3">');allPersons[e].gruppe[c].comment!=null&&f.push(allPersons[e].gruppe[c].comment);f.push("</textarea>");f.push("</table>");return f.join("")};
a._saveEditEntryData=function(e,c,f,g){var h=this,i=$.extend({},allPersons[e]);obj=h.getSaveObjectFromInputFields(e,c,allPersons[e]);if(obj.func=="f_address")allPersons[e].geolat="";if(masterData.fields[obj.func]==null)if(obj.func=="f_note"){obj.note=$("#InputNote").val();obj.comment_viewer=$("#InputComment").val();allPersons[e].details=null}else if(obj.func=="editPersonGroupRelation"||obj.func=="addPersonGroupRelation"){c={};obj.date=$("#InputDate").val().toDateDe().toStringEn();obj.leader=$("#InputGroupLeader").val();
if($("#InputComment").val()!=""){obj.comment=$("#InputComment").val();c.comment=obj.comment}obj.g_id=$("#InputGroupEntry").val();c.id=obj.g_id;c.d=obj.date;c.leiter=obj.leader;if(obj.func=="editPersonGroupRelation"){c.followup_count_no=allPersons[e].gruppe[c.id].followup_count_no;obj.followup_count_no=c.followup_count_no;c.followup_add_diff_days=allPersons[e].gruppe[c.id].followup_add_diff_days}if(allPersons[e].gruppe==null)allPersons[e].gruppe={};allPersons[e].gruppe[c.id]=c;if(masterData.groups[obj.g_id].followup_typ_id>
0&&obj.leader==0){if(allPersons[e].gruppe[c.id].followup_count_no==null){alert('Followup "'+masterData.followupTypes[masterData.groups[obj.g_id].followup_typ_id].bezeichnung+'" wurde gestartet!');c.followup_count_no=1;obj.followup_count_no=1}f=true}}else if(obj.func=="f_bereich"){var j=false,l={};$.each(masterData.auth.dep,function(m){$("input[id=InputBereich"+m+"]").each(function(){if($(this).attr("checked")){checked=1;j=true;l[m]=m}else checked=0;obj["bereich"+m]=checked})});if(j)allPersons[e].access=
l;else{alert("Die Person muss mindestens einem Bereich zugewiesen werden!");return false}}else if(obj.func=="f_image")if($("#uploadfilename").val()==null){alert("Bitte erst Datei hochladen!");return null}else{obj.id=e;obj.url=$("#uploadfilename").val();allPersons[e].imageurl=obj.url}else if(obj.func.indexOf("del_note")==0){obj.func="del_note";obj.comment_id=c.substr(8,99);allPersons[e].details=null}else if(obj.func.indexOf("archivePerson")==0){obj.func="archivePerson";allPersons[e].archiv_yn=1;f=
true}else if(obj.func.indexOf("undoArchivePerson")==0){obj.func="undoArchivePerson";allPersons[e].archiv_yn=0;f=true}g.html("Die Daten werden gespeichert...");churchInterface.jsonWrite(obj,function(m){g.dialog("close");g.html("");m||(allPersons[e]=i);if(obj.func=="delete_user"){allPersons[e]=null;h.renderList()}else if(f){churchInterface.getCurrentView().renderView();churchInterface.getCurrentView().renderTodos()}else{h.renderList(allPersons[e]);h.renderTodos()}})};
function getAuthAsDataArray(e){var c=[];if(e==null)e=true;$.each(masterData.auth_table,function(f,g){c.push(form_prepareDataEntry(-1,"== "+f+" =="));$.each(g,function(h,i){if(e||i.datenfeld==null)c.push(form_prepareDataEntry(i.id,i.auth))})});return c}a=PersonView.prototype;
a.msg_filterChanged=function(e,c){if(e!="filterMeine Gruppen"&&this.filter["filterMeine Gruppen"]!=null&&this.filter["filterMeine Gruppen"].indexOf("filter")==0){delete this.filter["filterMeine Gruppen"];this.msg_filterChanged("filterMeine Gruppen",null)}else if(e=="filterMeine Gruppen"){$("#cdb_group").html("");if(masterData.settings.selectedMyGroup!=this.filter["filterMeine Gruppen"]){masterData.settings.selectedMyGroup=this.filter["filterMeine Gruppen"];churchInterface.jsonWrite({func:"saveSetting",
sub:"selectedMyGroup",val:masterData.settings.selectedMyGroup==null?"null":masterData.settings.selectedMyGroup})}if(typeof this.filter["filterMeine Gruppen"]=="string"&&this.filter["filterMeine Gruppen"].indexOf("filter")==0){e=this.filter["filterMeine Gruppen"];this.filter=new cc_copyArray(masterData.settings.filter[this.filter["filterMeine Gruppen"].substr(6,99)]);this.makeFilterStatus("Status",this.filter.filterStatus);this.makeFilterStatus("Station",this.filter.filterStation);this.makeFilterStatus("Bereich",
this.filter.filterBereich,masterData.auth.dep);this.filter["filterMeine Gruppen"]=e;this.renderFurtherFilter()}else if(typeof c=="string"&&c.indexOf("filter")==0){e=this.filter["filterMeine Gruppen"];this.resetPersonFilter();this.resetGroupFilter();this.filter["filterMeine Gruppen"]=e;this.renderFurtherFilter()}if(this.filter["filterMeine Gruppen"]>0){if(groupMeetingStats==null||groupMeetingStats[this.filter["filterMeine Gruppen"]==null])cdb_loadGroupMeetingStats(this.filter,this.filter["filterMeine Gruppen"]);
churchInterface.getCurrentView()==personView&&this.renderGroupEntry()}this.renderFilter()}};
a.renderPersonFilter=function(){var e=[];e.push('<div style="float:right;margin-top:10px;margin-right:10px;"><a href="#" title="Filter zur&uuml;cksetzen" id="reset_personfilter"><img style="vertical-align:middle" width=20px src="'+masterData.modulespath+'/images/delete_2.png"/></a></div>');e.push('<div class="well"><table cellpadding=5px>');e.push("<tr><td>"+form_renderSelect({cssid:"filterFamilienstatus",data:masterData.familyStatus,label:"Familenstatus",selected:this.getFilter("filterFamilienstatus"),
freeoption:true,type:"small"}));e.push("<td>"+form_renderSelect({cssid:"filterGeschlecht",data:masterData.sex,label:"Geschlecht",selected:this.getFilter("filterGeschlecht"),freeoption:true,type:"small"}));e.push("<td>"+form_renderInput({size:3,cssid:"ageFrom",label:"Alter von",placeholder:"von",value:this.getFilter("ageFrom"),type:"xmini"}));e.push("<td>"+form_renderInput({size:3,cssid:"ageTo",label:"bis",placeholder:"bis",value:this.getFilter("ageTo"),type:"xmini"}));e.push("<td>"+form_renderInput({size:3,
cssid:"plz",label:"PLZ",placeholder:"PLZ",value:this.getFilter("plz"),type:"mini"}));e.push("<td>"+form_renderInput({size:3,cssid:"geburtsort",label:"Geburtsort",placeholder:"Geburtsort",value:this.getFilter("geburtsort"),type:"mini"}));e.push("<td>"+form_renderSelect({cssid:"filterNationalitaet",data:masterData.nationalitaet,label:"Nationalit&auml;t",selected:this.getFilter("filterNationalitaet"),freeoption:true,type:"medium"}));var c="";$.each(masterData.status,function(h,i){if(i.mitglied_yn==1)c=
c+i.kuerzel+","});e.push('<td width="190px">');e.push(form_renderCheckbox({cssid:"withoutEMail",checked:this.filter.withoutEMail,controlgroup:false,label:"Kein E-Mail vorhanden"}));e.push(form_renderCheckbox({cssid:"withoutPicture",checked:this.filter.withoutPicture,controlgroup:false,label:"Kein Bild vorhanden"}));e.push('</table><table cellpadding="5px" class=""><tr>');var f=[];$.each(masterData.fields.f_church.fields,function(h,i){i.type=="date"&&f.push(form_prepareDataEntry(i.sql,i.text))});e.push("<td>"+
form_renderSelect({cssid:"filterDates",data:f,label:"Datumsfilter",selected:this.getFilter("filterDates"),freeoption:true,type:"medium",controlgroup:true}));e.push("<td>"+form_renderInput({size:10,hint:"TT.MM.JJJJ oder z.Bsp. 1t, 1w oder 1m",cssid:"dateAfter",label:"ab",placeholder:"ab",value:this.getFilter("dateAfter"),type:"small",controlgroup:true}));e.push("<td>"+form_renderInput({size:10,hint:"TT.MM.JJJJ oder z.Bsp. 1t, 1w oder 1m",cssid:"dateBefore",label:"bis",placeholder:"bis",value:this.getFilter("dateBefore"),
type:"small",controlgroup:true}));e.push('<td width="180px">'+form_renderCheckbox({cssid:"dateIgnoreYear",label:"Jahr ignorieren",controlgroup:false,checked:this.getFilter("dateIgnoreYear")}));e.push(""+form_renderCheckbox({cssid:"dateNotSet",label:"Datum nicht vorhanden",controlgroup:false,checked:this.getFilter("dateNotSet")}));e.push('</table><table cellpadding="5px" class=""><tr>');f=[];f.push(form_prepareDataEntry(1,"aktiv"));f.push(form_prepareDataEntry(2,"&uuml;berf&auml;llig"));f.push(form_prepareDataEntry(3,
"nicht im FollowUp"));e.push("<td>"+form_renderSelect({cssid:"filterFollowUp",data:f,label:"Followup ",selected:this.getFilter("filterFollowUp"),freeoption:true,type:"medium",controlgroup:true}));if(this.filter.filterFollowUp>0){f=[];f.push(form_prepareDataEntry(1,"Step 1"));f.push(form_prepareDataEntry(2,"Step 2"));f.push(form_prepareDataEntry(3,"Step 3"));f.push(form_prepareDataEntry(4,"Step 4"));e.push("<td>"+form_renderSelect({cssid:"filterFollowUpStep",label:"Step ",data:f,selected:this.getFilter("filterFollowUpStep"),
freeoption:true,type:"medium",controlgroup:true}))}if(masterData.auth.viewtags){var g=0;do{e.push("<td>&nbsp;<td>"+form_renderSelect({cssid:"filterTags"+g,data:masterData.tags,label:"Tag "+(g+1),selected:this.getFilter("filterTags"+g),freeoption:true,type:"medium",controlgroup:true}));g+=1}while(this.filter["filterTags"+(g-1)]!=null)}if(masterData.auth.adminpersons){e.push("<td> &nbsp;  &nbsp;  ");e.push("<td>"+form_renderSelect({data:getAuthAsDataArray(true),sort:false,label:"Zugriffsrechte",cssid:"filterAuth",
freeoption:true,type:"medium",selected:this.filter.filterAuth}));e.push("<td>"+form_renderCheckbox({cssid:"filterAuthNegativ",label:"!",checked:this.getFilter("filterAuthNegativ")}))}e.push("</table>");e.push("</div>");$("#furtherFilterDetail").html(e.join(""))};
a.renderGroupFilter=function(){var e=[];e.push('<div style="float:right;margin-top:10px;margin-right:10px;"><a href="#" title="Filter zur&uuml;cksetzen" id="reset_groupfilter"><img style="vertical-align:middle" width=20px src="'+masterData.modulespath+'/images/delete_2.png"/></a></div>');e.push('<div class="well"><table cellpadding="5px" class="">');if(this.filter["filterTyp 1"]==null)this.filter["filterTyp 1"]="";for(k=1;this.filter["filterTyp "+k]!=null;){e.push("<tr><td>");e.push(form_renderSelect({data:masterData.groupFilterTypes,
label:"Filter "+k,selected:this.filter["filterFilter "+k],cssid:"filterFilter "+k,controlgroup:true,type:"small"}));e.push("<td>"+form_renderSelect({data:masterData.groupTypes,label:"Typ "+k,selected:this.filter["filterTyp "+k],cssid:"filterTyp "+k,controlgroup:true,freeoption:true,type:"medium"}));e.push("<td>");e.push(form_renderSelect({data:masterData.groups,label:"Gruppe "+k,selected:this.filter["filterGruppe "+k],cssid:"filterGruppe "+k,controlgroup:true,freeoption:true,type:"medium",func:function(c){return(t.filter["filterTyp "+
k]==""||c.gruppentyp_id==t.filter["filterTyp "+k])&&groupView.isAllowedToSee(c.id)&&masterData.groups[c.id].valid_yn==1&&(t.filter["filterDistrikt "+k]==null||t.filter["filterDistrikt "+k]==""||t.filter["filterDistrikt "+k]==c.distrikt_id)}}));e.push("<td>");e.push(form_renderSelect({data:masterData.districts,label:"Distrikt "+k,selected:this.filter["filterDistrikt "+k],cssid:"filterDistrikt "+k,controlgroup:true,freeoption:true,type:"medium"}));e.push("<td>");e.push(form_renderSelect({data:masterData.groupMemberTypes,
label:"Teilnehmerstatus "+k,selected:this.filter["filterTeilnehmerstatus "+k],cssid:"filterTeilnehmerstatus "+k,controlgroup:true,freeoption:true,type:"medium",func:function(c){return c.gruppentyp_id==t.filter["Teilnehmerstatus "+k]}}));e.push("<td>"+form_renderImage({src:"trashbox.png",cssid:"delete-groupfilter-"+k,width:24}));e.push("<tr><td>");if(k==1)e.push('<br/><p align="center"><input title="An=ODER oder Aus=UND-Verkn&uuml;pfung" type="checkbox" id="filterOr" '+(this.filter.filterOr!=null?
"checked":"")+" > <small>ODER-Verkn&uuml;pfung</small> ");if(this.filter["filterFilter "+k]==null||this.filter["filterFilter "+k]==0){e.push('<td colspan=5><font style="font-size:8pt;">Neu in der Gruppe ');e.push('ab: <input type="text" class="input-small" size="10"  title="TT.MM.JJJJ oder z.Bsp. 1t, 1w oder 1m"  id="filterGruppeInAb '+k+'"/ value="'+this.getFilter("filterGruppeInAb "+k)+'">&nbsp;&nbsp; &nbsp;');e.push('<font style="font-size:8pt;">Ist in der Gruppe seit mindestens: <input type="text" class="input-small" size="10"  title="TT.MM.JJJJ oder z.Bsp. 1t, 1w oder 1m" id="filterGruppeInSeit '+
k+'"/ value="'+this.getFilter("filterGruppeInSeit "+k)+'">&nbsp;')}else if(this.filter["filterFilter "+k]==2){e.push('<td colspan=5><font style="font-size:8pt;">War in der Gruppe ');e.push('vom: <input type="text" size="10" class="input-small"  title="TT.MM.JJJJ oder z.Bsp. 1t, 1w oder 1m" id="filterGruppeWarInVon '+k+'"/ value="'+this.getFilter("filterGruppeWarInVon "+k)+'">&nbsp;&nbsp;');e.push('bis: <input type="text" size="10"  class="input-small" title="TT.MM.JJJJ oder z.Bsp. 1t, 1w oder 1m" id="filterGruppeWarInBis '+
k+'"/ value="'+this.getFilter("filterGruppeWarInBis "+k)+'">&nbsp;')}k+=1}e.push("<tr><td>"+form_renderImage({src:"plus.png",cssid:"add-groupfilter",width:24}));e.push("</table></div>");$("#furtherFilterDetail").html(e.join(""));$("#furtherFilterDetail a").click(function(){if($(this).attr("id").indexOf("delete-groupfilter-")==0){for(var c=$(this).attr("id").substr(19,99),f=c*1+1;t.filter["filterTyp "+f]!=null;){t.filter["filterTyp "+c]=t.filter["filterTyp "+f];t.filter["filterFilter "+c]=t.filter["filterFilter "+
f];t.filter["filterGruppe "+c]=t.filter["filterGruppe "+f];t.filter["filterDistrikt "+c]=t.filter["filterDistrikt "+f];t.filter["filterTeilnehmerstatus "+c]=t.filter["filterTeilnehmerstatus "+f];t.filter["filterfilterGruppeInAb "+c]=t.filter["filterfilterGruppeInAb "+f];t.filter["filterfilterGruppeInSeit "+c]=t.filter["filterfilterGruppeInSeit "+f];t.filter["filterfilterGruppeWarInVon "+c]=t.filter["filterfilterGruppeWarInVon "+f];t.filter["filterfilterGruppeWarInBis "+c]=t.filter["filterfilterGruppeWarInBis "+
f];c=f;f+=1}delete t.filter["filterTyp "+c];delete t.filter["filterFilter "+c];delete t.filter["filterGruppe "+c];delete t.filter["filterDistrikt "+c];delete t.filter["filterTeilnehmerstatus "+c];delete t.filter["filterfilterGruppeInAb "+c];delete t.filter["filterfilterGruppeInSeit "+c];delete t.filter["filterfilterGruppeWarInVon "+c];delete t.filter["filterfilterGruppeWarInBis "+c]}else if($(this).attr("id").indexOf("add-groupfilter")==0){for(f=1;t.filter["filterTyp "+f]!=null;)f+=1;t.filter["filterTyp "+
f]=""}})};
a.renderRelationFilter=function(){var e=this,c=[];c.push('<div style="float:right;margin-top:10px;margin-right:10px;"><a href="#" title="Filter zur&uuml;cksetzen" id="reset_relationfilter"><img style="vertical-align:middle" width=20px src="'+masterData.modulespath+'/images/delete_2.png"/></a></div>');c.push('<div class="well"><table cellpadding="5px"><tr>');var f=[];$.each(masterData.relationType,function(g,h){f.push(form_prepareDataEntry("k_"+h.id,h.bez_kind));h.bez_kind!=h.bez_vater&&f.push(form_prepareDataEntry("v_"+
h.id,h.bez_vater))});c.push("<td>"+form_renderSelect({cssid:"filterRelations",data:f,label:"Wer hat ein",selected:this.getFilter("filterRelations"),freeoption:true,type:"medium",controlgroup:true}));c.push("<td>"+form_renderCheckbox({cssid:"filterRelationNegativ",label:"!",checked:this.getFilter("filterRelationNegativ")}));c.push("<tr>");c.push("<td>"+form_renderSelect({cssid:"filterRelationExt",data:f,label:"Wer hat ein ",selected:this.getFilter("filterRelationExt"),controlgroup:true,freeoption:true,
type:"medium",controlgroup:true}));c.push("<td>");c.push(form_renderSelect({data:masterData.groupTypes,label:"in Gruppentyp ",selected:this.filter.filterRelationExtGroupTyp,cssid:"filterRelationExtGroupTyp",controlgroup:true,freeoption:true,type:"medium"}));c.push("<td>");c.push(form_renderSelect({data:masterData.groups,label:"in Gruppe ",selected:this.filter.filterRelationExtGroup,cssid:"filterRelationExtGroup",controlgroup:true,freeoption:true,type:"medium",func:function(g){return g.gruppentyp_id==
e.filter.filterRelationExtGroupTyp&&groupView.isAllowedToSee(g.id)&&masterData.groups[g.id].valid_yn==1}}));c.push("</table>");c.push("</div>");$("#furtherFilterDetail").html(c.join(""))};
a.renderFurtherFilter=function(){if(this.furtherFilterVisible){$("#divaddfilter").animate({height:"show"},"medium");var e=this,c=[];c.push('<ul class="nav nav-pills">');if(masterData.auth.viewalldata)c.push('<li class="'+(e.currentFurtherFilter=="person"?"active":"")+'"><a href="#" data-filter="person" class="filter">Personenfilter</a>');c.push('<li class="'+(e.currentFurtherFilter=="gruppe"?"active":"")+'"><a href="#" data-filter="gruppe" class="filter">Gruppenfilter</a>');if(masterData.auth.viewalldetails)c.push('<li class="'+
(e.currentFurtherFilter=="beziehung"?"active":"")+'"><a href="#" data-filter="beziehung" class="filter">Beziehungsfilter</a>');c.push('<li class="pull-right"><a href="#" class="hide">Filter schliessen</a>');c.push("</ul>");c.push('<div id="furtherFilterDetail"></div>');$("#addfilter").html(c.join(""));if(e.currentFurtherFilter=="person")e.renderPersonFilter();else e.currentFurtherFilter=="beziehung"?e.renderRelationFilter():e.renderGroupFilter();$("#divaddfilter a.hide").click(function(){e.furtherFilterVisible=
false;$("#divaddfilter").animate({height:"hide"},"fast");return false});$("#divaddfilter a.filter").click(function(){e.currentFurtherFilter=$(this).attr("data-filter");e.renderFurtherFilter();return false});$("#addfilter select").change(function(){});this.implantStandardFilterCallbacks(this,"addfilter");$("#furtherFilterDetail select").change(function(){e.renderFurtherFilter()});$("#furtherFilterDetail a").click(function(){if($(this).attr("id")=="reset_personfilter")e.resetPersonFilter();else if($(this).attr("id")==
"reset_groupfilter")e.resetGroupFilter();else if($(this).attr("id")=="reset_relationfilter")e.resetRelationFilter();else e.filter[$(this).attr("id")]=$(this).attr("checked");e.renderFurtherFilter();listOffset=0;e.renderList(null,false);return false})}else $("#divaddfilter").animate({height:"hide"},"fast")};
a.resetPersonFilter=function(){delete this.filter.plz;delete this.filter.ageFrom;delete this.filter.ageTo;delete this.filter.dateBefore;delete this.filter.dateAfter;delete this.filter.dateIgnoreYear;delete this.filter.filterNationalitaet;delete this.filter.geburtsort;delete this.filter.withoutPicture;delete this.filter.withoutEMail;delete this.filter.dateNotSet;delete this.filter.filterDates;delete this.filter.searchChecked;delete this.filter["filterMeine Gruppen"];delete this.filter.filterStation;
delete this.filter.filterBereich;delete this.filter.filterStatus;delete this.filter.filterGeschlecht;delete this.filter.filterFamilienstatus;for(z=0;this.filter["filterTags"+z]!=null;){delete this.filter["filterTags"+z];z+=1}delete this.filter.filterFollowUp;delete this.filter.filterFollowUpStep};a.resetRelationFilter=function(){delete this.filter.filterRelations;delete this.filter.filterRelationNegativ;delete this.filter.filterRelationExt;delete this.filter.filterRelationExtGroupTyp;delete this.filter.filterRelationExtGroup};
a.resetGroupFilter=function(){k=1;for(delete this.filter.filterOr;this.filter["filterTyp "+k]!=null;){delete this.filter["filterTyp "+k];delete this.filter["filterFilter "+k];delete this.filter["filterDistrikt "+k];delete this.filter["filterGruppe "+k];delete this.filter["filterGruppeInAb "+k];delete this.filter["filterGruppeInSeit "+k];delete this.filter["filterGruppeWarInVon "+k];delete this.filter["filterGruppeWarInBis "+k];k+=1}};
a.renderGroupEntry=function(){t=this;$("#cdb_group").html("");this.filter["filterMeine Gruppen"]>0&&allPersons[masterData.user_pid]!=null&&(allPersons[masterData.user_pid].districts!=null&&allPersons[masterData.user_pid].districts[masterData.groups[this.filter["filterMeine Gruppen"]].distrikt_id]!=null||allPersons[masterData.user_pid].gruppentypen!=null&&allPersons[masterData.user_pid].gruppentypen[masterData.groups[this.filter["filterMeine Gruppen"]].gruppentyp_id]!=null||allPersons[masterData.user_pid].gruppe[this.filter["filterMeine Gruppen"]].leiter>=
1&&allPersons[masterData.user_pid].gruppe[this.filter["filterMeine Gruppen"]].leiter<=2)&&masterData.groups[this.filter["filterMeine Gruppen"]].meetingList==null?t.loadGroupMeetingList(this.filter["filterMeine Gruppen"]):t.renderGroupContent(this.filter["filterMeine Gruppen"])};
a.loadGroupMeetingList=function(e){var c=this;masterData.groups[e].meetingList="get data";$.getJSON("index.php?q=churchdb/ajax",{func:"GroupMeeting",sub:"getList",g_id:e},function(f){if(f!=null){masterData.groups[e].meetingList=f;c.renderGroupContent(e);c.renderList()}else masterData.groups[e].meetingList=[]})};
a.exportData=function(){var e=this,c=masterData.max_exporter;if(masterData.auth["export"])c=99999;var f="",g={};$.each(allPersons,function(j,l){if(c>0&&e.checkFilter(l)){c--;f=f+l.id+",";l.rels!=null&&$.each(l.rels,function(m,n){if(masterData.relationType[n.beziehungstyp_id].export_aggregation_yn==1)if(n.vater_id==l.id&&e.checkFilter(allPersons[n.kind_id])||n.kind_id==l.id&&e.checkFilter(allPersons[n.vater_id]))g[n.beziehungstyp_id]=n.beziehungstyp_id})}});f+="-1";if(c==0)alert(unescape("Es d%FCrfen nur max. "+
masterData.max_exporter+" Eintr%E4ge exportiert werden. Bitte genauer filtern%21"));else if(this.filter.filterRelations!=null)this.showDialog("Beziehungen exportien","Es wird momentan nach Beziehungen gefiltert, sollen die durch die Beziehung verbundene Personen mit exportiert werden?",300,300,{Ja:function(){agg="&rel_part="+e.filter.filterRelations.substr(0,1);agg=agg+"&rel_id="+e.filter.filterRelations.substr(2,99);window.open("?q=churchdb/export&ids="+f+agg);$(this).dialog("close")},Nein:function(){window.open("?q=churchdb/export&ids="+
f);$(this).dialog("close")}});else if(masterData.auth.viewalldata){var h="";$.each(g,function(j,l){h=h+'<input type="checkbox" id="cb_'+l+'" class="cdb-checkbox"></input> &nbsp;'+masterData.relationType[l].bez_vater+"/"+masterData.relationType[l].bez_kind+"<br/>"});if(h!="")this.showDialog("Beziehungen zusammenfassen","Es wurden Beziehungen gefunden, welche sollen zusammengefasst werden?<br/><br/>"+h,400,350,{Ok:function(){var j="";$.each(g,function(l,m){if($("#cb_"+m).attr("checked"))j=j+"&agg"+
m+"=y"});window.open("?q=churchdb/export&ids="+f+j);$(this).dialog("close")},Abbrechen:function(){$(this).dialog("close")}});else var i=window.open("?q=churchdb/export&ids="+f)}else if(groupView.isPersonLeaderOfGroup(masterData.user_pid,this.getFilter("filterMeine Gruppen")))i=window.open("?q=churchdb/export&ids="+f);else alert("Um zu exportieren muss unter 'Meine Gruppen' eine Gruppe gefiltert werden, in der Du Leiter bist.")};
a.renderGroupContent=function(e){var c=null;if(masterData.groups!=null&&masterData.groups[e]!=null)c=masterData.groups[e].meetingList;var f=[];if(masterData.settings.selectedGroupType==-4){f.push('<div class="well">');if(c!=null){f.push('<legend>Gruppenteilnahme <a href="#" id="a_gruppenliste">'+masterData.groups[e].bezeichnung+"</a> im <i>"+monthNames[t.gruppenteilnehmerdatum.getMonth()]+" "+t.gruppenteilnehmerdatum.getFullYear()+"</i></legend>");f.push(form_renderButton({label:"<< Monat zur&uuml;ck",
cssid:"btn_monatback"})+" ");f.push(form_renderButton({label:"Monat vor >>",cssid:"btn_monatfurther"}))}f.push(form_renderButton({label:"Gruppenteilnahme schliessen",cssid:"btn_gruppenteilnahme",htmlclass:"pull-right"}));f.push("</div>")}var g=[],h=new Date;gruppentreffen_id=-1;if(c!=null){$.each(churchcore_sortData(c,"datumvon"),function(i,j){if(j.eintragerfolgt_yn==0){g.push('<input type="button" class="btn pull-right" value="Treffen ausgefallen"/>');g.push('<input type="button" class="btn pull-right" value="Auswahl absenden"/>');
j.datumvon.toDateEn(true).toStringDe(true)==j.datumbis.toDateEn(true).toStringDe(true)?g.push("<p><b>Bitte ausw&auml;hlen: Wer war am "+j.datumvon.toDateEn(true).toStringDe(true)+" da?</b>"):g.push("<p><b>Bitte ausw&auml;hlen: Wer war in der Zeit vom "+j.datumvon.toDateEn().toStringDe()+" - "+j.datumbis.toDateEn().toStringDe()+" da?</b>");g.push('<br><small>Zuerst die Personen markieren, die bei dem Treffen dabei gewesen sind. Dann auf "Auswahl absenden" klicken.</small>');gruppentreffen_id=j.id;
h=j.datumvon.toDateEn(true);return false}});if(gruppentreffen_id==-1)g=[]}g.length>0&&f.push('<div class="well">'+g.join("")+"</div>");$("#cdb_group").html(f.join(""));$("#cdb_group input, #cdb_group a").click(function(){if($(this).val()=="Auswahl absenden"){var i=[];$.each(allPersons,function(n,o){o.checked&&i.push(o.id)});var j=new CC_Form;j.addHtml("<p>"+i.length+" Personen einchecken</p>");j.addInput({label:"Anzahl G&auml;ste",value:0,cssid:"anzahl_gaeste"});j.addTextarea({label:"Kommentar",rows:4,
data:"",placeholder:"Kommentar",cssid:"kommentar"});j.addCheckbox({label:"Markierung der Personen wieder entfernen?",checked:true,cssid:"demarkPersons"});form_showDialog("Treffen "+h.toStringDe(true),j.render(null,"vertical"),360,400,{Speichern:function(){var n=j.getAllValsAsObject();n.func="GroupMeeting";n.sub="saveProperties";n.id=gruppentreffen_id;n.g_id=e;n.entries=i;churchInterface.jsendWrite(n,function(o){if(o){masterData.groups[e].meetingList=null;n.demarkPersons&&$.each(allPersons,function(p,
q){q.checked=false});t.renderGroupEntry();t.renderList()}else alert("Es gab ein Fehler beim Speichern!")});$(this).dialog("close")},Abbruch:function(){$(this).dialog("close")}})}else if($(this).attr("id")=="a_gruppenliste"){groupView.clearFilter();groupView.setFilter("filterMeine Gruppen",t.filter["filterMeine Gruppen"]);churchInterface.setCurrentView(groupView);return false}else if($(this).attr("id")=="btn_gruppenteilnahme"){var l=churchcore_getFirstElement(masterData.groupTypes),m=null;if(l!=null)m=
l.id;masterData.settings.selectedGroupType=m;churchInterface.jsonWrite({func:"saveSetting",sub:"selectedGroupType",val:m});t.renderGroupEntry();t.renderList()}else if($(this).attr("id")=="btn_monatback"){t.gruppenteilnehmerdatum.setMonth(t.gruppenteilnehmerdatum.getMonth()-1);t.renderGroupEntry();t.renderList()}else if($(this).attr("id")=="btn_monatfurther"){t.gruppenteilnehmerdatum.setMonth(t.gruppenteilnehmerdatum.getMonth()+1);t.renderGroupEntry();t.renderList()}else{$.getJSON("index.php?q=churchdb/ajax",
{func:"GroupMeeting",sub:"canceled",gt_id:gruppentreffen_id},function(){masterData.groups[t.filter["filterMeine Gruppen"]].meetingList=null;t.renderGroupEntry();t.renderList()});$("#cdb_group").html("")}})};a.smser=function(){var e=this,c=[];$.each(allPersons,function(f,g){e.checkFilter(g)&&c.push(g.id)});c.length>0&&e.smsPerson(c)};
a.smsPerson=function(e){var c=new CC_Form("SMS an "+e.length+" Personen versenden");c.addTextarea({label:"SMS-Text",rows:4,cssid:"smstxt",data:""});c.addHtml('<div class="control-group controls"><p><small><span id="count_zeichen"></span></small></div>');c.addHtml("<p><small>Hinweis: Es kann [Vorname], [Nachname] und [Spitzname] verwendet werden.</small>");var f=t.showDialog("SMS versenden",c.render(false,"horizontal"),500,350,{Senden:function(){var g=c.getAllValsAsObject();g.func="sendsms";g.ids=
e;churchInterface.jsendWrite(g,function(h,i){if(h){i.withoutmobilecount>0&&alert(i.withoutmobilecount+" Person haben keine Handynummer gespeichert.");$.each(e,function(j,l){$("tr[id="+l+"]").after('<tr id="detail'+l+'"><td colspan="10">SMS-Versand Ergebnis: '+i[l])})}else alert(i)});$(this).dialog("close")},Abbruch:function(){$(this).dialog("close")}});f.find("#smstxt").keyup(function(){$(this).val().length>1?f.find("#count_zeichen").html($(this).val().length+" Zeichen"):f.find("#count_zeichen").html("")})};
a.mailer=function(){if(!masterData.auth.viewalldata&&!groupView.isPersonLeaderOfGroup(masterData.user_pid,this.getFilter("filterMeine Gruppen"))){alert("Um den E-Mailer zu nutzen muss unter 'Meine Gruppen' eine Gruppe gefiltert werden, in der Du Leiter bist.");return null}var e=this,c=0,f=masterData.max_exporter;if(masterData.auth["export"])f=99999;var g="",h="",i=false,j=masterData.settings.mailerSeparator==0?";":",";if(masterData.settings.mailerType!=0)j+=" ";$.each(allPersons,function(n,o){if(c<=
f&&e.checkFilter(o))if(o.email!=null&&o.email!=""){c++;g=g+$.trim(o.email)+j;h=h+o.id+","}else i=true});if(c>=f)alert(unescape("Es d%FCrfen nur max. "+masterData.max_exporter+" Eintr%E4ge exportiert werden. Bitte genauer filtern%21"));else{if(i&&confirm("Einige Personen haben keine E-Mail-Adresse, sollen diese anschliessend angezeigt werden?")){e.filter.withoutEMail=1;if(!e.furtherFilterVisible){e.furtherFilterVisible=true;e.renderFurtherFilter()}e.renderList()}if(masterData.settings.mailerType==
0){if(masterData.settings.mailerBcc==null)masterData.settings.mailerBcc=0;var l="";l=masterData.settings.mailerBcc==0?"mailto:"+g:"mailto:"+allPersons[masterData.user_pid].email+"?bcc="+g;var m=window.open(l,"Mailer");window.setTimeout(function(){m.close()},500)}else if(masterData.settings.mailerType==1){m=window.open("","E-Mail-Adresse","width=500,height=300");m.document.write(g);m.focus()}else masterData.settings.mailerType==2&&e.mailPerson(h+"-1",g.trim(60))}};
function _createEntry(e,c){var f=[];f.id=e;f.bezeichnung=c;return f}
PersonView.prototype.getMyGroupsSelector=function(e){var c=churchInterface.getCurrentView();if(e==null)e=false;var f=[],g=-1;if(masterData.settings.selectedMyGroup!=null&&masterData.settings.selectedMyGroup!="null"&&c.filter["filterMeine Gruppen"]!=masterData.settings.selectedMyGroup)if(e||masterData.settings.selectedMyGroup.indexOf("filter")!=0)if(c.filter.searchEntry==null){c.filter["filterMeine Gruppen"]=masterData.settings.selectedMyGroup;this.msg_filterChanged("filterMeine Gruppen",null)}if(masterData.user_pid!=
null&&allPersons[masterData.user_pid]!=null){d=new Date;d.addDays(-14);f.push(_createEntry("",""));var h=[];allPersons[masterData.user_pid].gruppe!=null&&$.each(allPersons[masterData.user_pid].gruppe,function(l,m){if(masterData.groups[m.id].abschlussdatum==null||masterData.groups[m.id].abschlussdatum.toDateEn()>d)if(m.leiter>=1&&m.leiter<=3){h.push(masterData.groups[m.id]);if(g==-1)g=m.id}});allPersons[masterData.user_pid].districts!=null&&$.each(allPersons[masterData.user_pid].districts,function(l,
m){$.each(masterData.groups,function(n,o){if(o.distrikt_id==m.distrikt_id&&(o.abschlussdatum==null||o.abschlussdatum.toDateEn()>d))if(!churchcore_inArray(o,h)){h.push(o);if(g==-1)g=o.id}})});allPersons[masterData.user_pid].gruppentypen!=null&&$.each(allPersons[masterData.user_pid].gruppentypen,function(l,m){$.each(masterData.groups,function(n,o){if(o.gruppentyp_id==m.gruppentyp_id&&(o.abschlussdatum==null||o.abschlussdatum.toDateEn()>d))if(!churchcore_inArray(o,h)){h.push(o);if(g==-1)g=o.id}})});
if(h.length>0){f.push(_createEntry(-1,"-- Leiter --"));f=f.concat(churchcore_sortArray(h,"bezeichnung"))}var i=[];allPersons[masterData.user_pid].gruppe!=null&&$.each(allPersons[masterData.user_pid].gruppe,function(l,m){if(masterData.groups[m.id].abschlussdatum==null||masterData.groups[m.id].abschlussdatum.toDateEn()>d)if(m.leiter==0&&groupView.isGroupViewableForMembers(m.id)||m.leiter==4&&masterData.groups[m.id].versteckt_yn==0){i.push(masterData.groups[m.id]);if(g==-1)g=m.id}});if(i.length>0){f.push(_createEntry(-1,
"-- Teilnehmer --"));f=f.concat(churchcore_sortArray(i,"bezeichnung"))}if(e&&masterData.settings.filter!=null){var j=[];$.each(masterData.settings.filter,function(l){var m=[];m.id="filter"+l;m.bezeichnung="&nbsp; "+l;j.push(m)});if(j.length>0){f.push(_createEntry(-1,"-- Intellig. Gruppen --"));f=f.concat(churchcore_sortArray(j,"bezeichnung"))}}if(f.length==0)f.push(_createEntry(-1,"Keine eigene Gruppe"));else if(c.filter["filterMeine Gruppen"]==-1&&c.filter.searchEntry==null)c.filter["filterMeine Gruppen"]=
g;return f}return false};
